<!-- HTML header for doxygen 1.8.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Soletta™ Framework: /src/samples/flow/c-api/single-node.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Soletta™ Framework
   </div>
   <div id="projectbrief">
   Framework for making IoT devices<br /><br />
   <small>
   <a href="http://solettaproject.github.io/docs/">Full online documentation</a> | 
   <a href="index.html">C API Index</a>
   </small><br />
   </div>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">/src/samples/flow/c-api/single-node.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This file is part of the Soletta (TM) Project</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2015 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></div>
<div class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></div>
<div class="line"><span class="comment"> * You may obtain a copy of the License at</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     http://www.apache.org/licenses/LICENSE-2.0</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></div>
<div class="line"><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></div>
<div class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></div>
<div class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></div>
<div class="line"><span class="comment"> * limitations under the License.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="sol-flow-single_8h.html">sol-flow-single.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="sol-log_8h.html">sol-log.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="sol-util_8h.html">sol-util.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="soletta_8h.html">soletta.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="group__Flow.html#gafe1a5e24c9138afad039a07adc54b51d">sol_flow_node</a> *<a name="a0"></a><a class="code" href="single-node_8c.html#ae348e350b6f04a614d012cce3f77dc52">minutes</a>, *<a name="a1"></a><a class="code" href="single-node_8c.html#ad78c3465d91d87d61a218acf991a77fc">seconds</a>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> uint16_t <a name="a2"></a><a class="code" href="single-node_8c.html#a697fc2fd5b2a8596566e4e750842ada2">minutes_port_out</a>, <a name="a3"></a><a class="code" href="single-node_8c.html#a3485127700f912784610ea7410e236fe">minutes_port_enabled</a>;</div>
<div class="line"><span class="keyword">static</span> uint16_t <a name="a4"></a><a class="code" href="single-node_8c.html#a4c42c0f6740ecda28dc7e64721a748c6">seconds_port_out</a>, <a name="a5"></a><a class="code" href="single-node_8c.html#a93ba8f94353d17acc7963a71aa390724">seconds_port_enabled</a>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> int32_t</div>
<div class="line"><a name="a6"></a><a class="code" href="single-node_8c.html#a558a1a7f379d050200743d2bcb5fb620">get_int32_packet_and_log</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="group__Flow.html#gafe1a5e24c9138afad039a07adc54b51d">sol_flow_node</a> *n, uint16_t <a name="a7"></a><a class="code" href="server-sse_8c.html#a63c89c04d1feae07ca35558055155ffb">port</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="group__FlowPacket.html#ga7929cae9ca6118d28b412b7bd6fe2626">sol_flow_packet</a> *packet)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">struct </span><a name="_a8"></a><a class="code" href="structsol__flow__node__type.html">sol_flow_node_type</a> *type;</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">struct </span>sol_flow_port_description *port_desc;</div>
<div class="line">    int32_t <a name="a9"></a><a class="code" href="server_8c.html#acda54b23a3b92ae2efa63634288c0496">value</a>;</div>
<div class="line">    <span class="keywordtype">int</span> err;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* get the struct sol_irange::value member. This function also validates if the</span></div>
<div class="line"><span class="comment">     * given packet is of requested type (irange), otherise will return an -errno.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    err = <a name="a10"></a><a class="code" href="group__FlowPacket.html#ga1a1008662ea45beeedf50317b64ce631">sol_flow_packet_get_irange_value</a>(packet, &amp;value);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;ERROR: could not get irange packet value: %p %s\n&quot;</span>,</div>
<div class="line">            packet, <a name="a11"></a><a class="code" href="group__Utils.html#gab584188ab3f38605dab8b04aaa85913d">sol_util_strerrora</a>(-err));</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* log the value to stdout. First we get the node type from</span></div>
<div class="line"><span class="comment">     * current node (minutes or seconds), then we find the port</span></div>
<div class="line"><span class="comment">     * description from its index. with that we can get the port name.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    type = <a name="a12"></a><a class="code" href="group__Flow.html#gad4460081355bcee434ee17b599ffb23e">sol_flow_node_get_type</a>(n);</div>
<div class="line">    port_desc = sol_flow_node_get_description_port_out(type, port);</div>
<div class="line">    <span class="keywordflow">if</span> (!port_desc) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;ERROR: no output port description for index %&quot;</span> PRIu16</div>
<div class="line">            <span class="stringliteral">&quot; of node %p\n&quot;</span>,</div>
<div class="line">            port, n);</div>
<div class="line">        <span class="keywordflow">return</span> -ENOENT;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;node type %s port #%&quot;</span> PRIu16 <span class="stringliteral">&quot; &#39;%s&#39; (%s): %&quot;</span> PRId32 <span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">        type-&gt;description-&gt;name, port, port_desc-&gt;name,</div>
<div class="line">        port_desc-&gt;data_type, value);</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="server_8c.html#acda54b23a3b92ae2efa63634288c0496">value</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="a13"></a><a class="code" href="single-node_8c.html#a3651efcf0c3a5520e1a735baba4d52b9">on_minutes_packet</a>(<span class="keywordtype">void</span> *data, <span class="keyword">struct</span> <a class="code" href="group__Flow.html#gafe1a5e24c9138afad039a07adc54b51d">sol_flow_node</a> *n, uint16_t <a class="code" href="server-sse_8c.html#a63c89c04d1feae07ca35558055155ffb">port</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="group__FlowPacket.html#ga7929cae9ca6118d28b412b7bd6fe2626">sol_flow_packet</a> *packet)</div>
<div class="line">{</div>
<div class="line">    int32_t <a class="code" href="server_8c.html#acda54b23a3b92ae2efa63634288c0496">value</a> = <a class="code" href="single-node_8c.html#a558a1a7f379d050200743d2bcb5fb620">get_int32_packet_and_log</a>(n, port, packet);</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">int</span> i = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (value &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* do some logic.</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * Here we will disconnect the &#39;OUT&#39; output port from &#39;seconds&#39;,</span></div>
<div class="line"><span class="comment">     * this would have single-node to stop delivering packets on that</span></div>
<div class="line"><span class="comment">     * port to &#39;on_seconds_packet()&#39;, if running with</span></div>
<div class="line"><span class="comment">     * SOL_LOG_LEVELS=sol-flow:4 you&#39;d see that packets were dropped.</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * And we send a boolean packet with value &#39;false&#39; to the input</span></div>
<div class="line"><span class="comment">     * port &#39;ENABLED&#39; of &#39;seconds&#39; node so it will stop emitting these</span></div>
<div class="line"><span class="comment">     * packets.</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * in the next minute we reverse it, re-connecting the &#39;OUT&#39; port</span></div>
<div class="line"><span class="comment">     * and sending true to &#39;ENABLED&#39;.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    i++;</div>
<div class="line">    <span class="keywordflow">if</span> (i == 1)</div>
<div class="line">        <span class="keywordflow">return</span>; <span class="comment">/* first time let it go */</span></div>
<div class="line">    <span class="keywordflow">if</span> (i % 2 == 0) {</div>
<div class="line">        puts(<span class="stringliteral">&quot;stop seconds and disconnect output port, will change in 1 minute&quot;</span>);</div>
<div class="line">        <a name="a14"></a><a class="code" href="group__SingleFlow.html#gaed1ee4b120b9f83802813168bb8d62bf">sol_flow_single_disconnect_port_out</a>(<a class="code" href="single-node_8c.html#ad78c3465d91d87d61a218acf991a77fc">seconds</a>, <a class="code" href="single-node_8c.html#a4c42c0f6740ecda28dc7e64721a748c6">seconds_port_out</a>);</div>
<div class="line">        <a name="a15"></a><a class="code" href="group__Flow.html#gae760e900ca018e9755296fef4e141561">sol_flow_send_bool_packet</a>(<a class="code" href="single-node_8c.html#ad78c3465d91d87d61a218acf991a77fc">seconds</a>, <a class="code" href="single-node_8c.html#a93ba8f94353d17acc7963a71aa390724">seconds_port_enabled</a>, <span class="keyword">false</span>);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        puts(<span class="stringliteral">&quot;start seconds and connect output port, will change in 1 minute&quot;</span>);</div>
<div class="line">        <a name="a16"></a><a class="code" href="group__SingleFlow.html#ga960189068906146a92a4967c28f93de0">sol_flow_single_connect_port_out</a>(<a class="code" href="single-node_8c.html#ad78c3465d91d87d61a218acf991a77fc">seconds</a>, <a class="code" href="single-node_8c.html#a4c42c0f6740ecda28dc7e64721a748c6">seconds_port_out</a>);</div>
<div class="line">        <a class="code" href="group__Flow.html#gae760e900ca018e9755296fef4e141561">sol_flow_send_bool_packet</a>(<a class="code" href="single-node_8c.html#ad78c3465d91d87d61a218acf991a77fc">seconds</a>, <a class="code" href="single-node_8c.html#a93ba8f94353d17acc7963a71aa390724">seconds_port_enabled</a>, <span class="keyword">true</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="a17"></a><a class="code" href="single-node_8c.html#a69fe929a52d32ad268547620f74d4cd9">on_seconds_packet</a>(<span class="keywordtype">void</span> *data, <span class="keyword">struct</span> <a class="code" href="group__Flow.html#gafe1a5e24c9138afad039a07adc54b51d">sol_flow_node</a> *n, uint16_t port, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="group__FlowPacket.html#ga7929cae9ca6118d28b412b7bd6fe2626">sol_flow_packet</a> *packet)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* do no logic, just print to stdout. */</span></div>
<div class="line">    <a class="code" href="single-node_8c.html#a558a1a7f379d050200743d2bcb5fb620">get_int32_packet_and_log</a>(n, port, packet);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="a18"></a><a class="code" href="single-node_8c.html#a628d35a3d6e3e51f4a89fe34b5b9f499">create_minutes</a>(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structsol__flow__node__type.html">sol_flow_node_type</a> **type;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a19"></a><a class="code" href="structsol__flow__node__named__options.html">sol_flow_node_named_options</a> named_opts = {};</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *strv_opts[] = {</div>
<div class="line">        <span class="stringliteral">&quot;send_initial_packet=1&quot;</span>,</div>
<div class="line">        NULL</div>
<div class="line">    };</div>
<div class="line">    <span class="keyword">struct </span><a name="_a20"></a><a class="code" href="structsol__flow__node__options.html">sol_flow_node_options</a> *opts;</div>
<div class="line">    <span class="keywordtype">int</span> err;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Resolves the type based on its name. This will take care of</span></div>
<div class="line"><span class="comment">     * built-in modules and external modules, loading on demand as</span></div>
<div class="line"><span class="comment">     * required. This macro also handles static-compiles, so the</span></div>
<div class="line"><span class="comment">     * second parameter is the C symbol to be used in such case.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    err = <a name="a21"></a><a class="code" href="group__Flow.html#gaeaa33e245d6e3b27f8fb1f5d6bffd664">sol_flow_get_node_type</a>(<span class="stringliteral">&quot;wallclock&quot;</span>,</div>
<div class="line">        SOL_FLOW_NODE_TYPE_WALLCLOCK_MINUTE, &amp;type);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        fputs(<span class="stringliteral">&quot;could not find type: wallclock/minute\n&quot;</span>, stderr);</div>
<div class="line">        <a name="a22"></a><a class="code" href="group__Mainloop.html#gab1deec1c7e4da3b7b8caeafe9369b816">sol_quit_with_code</a>(EXIT_FAILURE);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* For efficiency matters Soletta doesn&#39;t work with port names,</span></div>
<div class="line"><span class="comment">     * rather using port indexes. If</span></div>
<div class="line"><span class="comment">     * SOL_FLOW_NODE_TYPE_DESCRIPTION_ENABLED, then we can resolve</span></div>
<div class="line"><span class="comment">     * strings to numbers, otherwise it is required to check the port</span></div>
<div class="line"><span class="comment">     * numbers, which are often available in the header file such as</span></div>
<div class="line"><span class="comment">     * sol-flow/wallclock.h such as</span></div>
<div class="line"><span class="comment">     * SOL_FLOW_NODE_TYPE_WALLCLOCK_MINUTE__OUT__OUT.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <a class="code" href="single-node_8c.html#a3485127700f912784610ea7410e236fe">minutes_port_enabled</a> = sol_flow_node_find_port_in(*type, <span class="stringliteral">&quot;ENABLED&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="single-node_8c.html#a3485127700f912784610ea7410e236fe">minutes_port_enabled</a> == UINT16_MAX) {</div>
<div class="line">        fputs(<span class="stringliteral">&quot;ERROR: couldn&#39;t find ouput port by name: ENABLED\n&quot;</span>, stderr);</div>
<div class="line">        <a class="code" href="group__Mainloop.html#gab1deec1c7e4da3b7b8caeafe9369b816">sol_quit_with_code</a>(EXIT_FAILURE);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="single-node_8c.html#a697fc2fd5b2a8596566e4e750842ada2">minutes_port_out</a> = sol_flow_node_find_port_out(*type, <span class="stringliteral">&quot;OUT&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="single-node_8c.html#a697fc2fd5b2a8596566e4e750842ada2">minutes_port_out</a> == UINT16_MAX) {</div>
<div class="line">        fputs(<span class="stringliteral">&quot;ERROR: couldn&#39;t find ouput port by name: OUT\n&quot;</span>, stderr);</div>
<div class="line">        <a class="code" href="group__Mainloop.html#gab1deec1c7e4da3b7b8caeafe9369b816">sol_quit_with_code</a>(EXIT_FAILURE);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* wallclock/minute takes a boolean option send_initial_packet.</span></div>
<div class="line"><span class="comment">     * We have couple of options to create it:</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * 1 - include sol-flow/wallclock.h, declare a variable of type</span></div>
<div class="line"><span class="comment">     *     struct sol_flow_node_type_wallclock_minute_options and fill</span></div>
<div class="line"><span class="comment">     *     its members. This requires sol-flow/wallclock.h to be</span></div>
<div class="line"><span class="comment">     *     avaiable, but is more efficient since goes straight to the</span></div>
<div class="line"><span class="comment">     *     point, no parsing or memory allocations. It would look</span></div>
<div class="line"><span class="comment">     *     like:</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     *        #include &lt;sol-flow/wallclock.h&gt;</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     *        struct sol_flow_node_type_wallclock_minute_options opts =</span></div>
<div class="line"><span class="comment">     *           SOL_FLOW_NODE_TYPE_WALLCLOCK_MINUTE_OPTIONS_DEFAULTS(</span></div>
<div class="line"><span class="comment">     *              .send_initial_packet = true);</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * 2 - access type-&gt;options_size,</span></div>
<div class="line"><span class="comment">     *     type-&gt;default_options and</span></div>
<div class="line"><span class="comment">     *     type-&gt;description-&gt;options and manually</span></div>
<div class="line"><span class="comment">     *     create the structure in runtime. This demands</span></div>
<div class="line"><span class="comment">     *     SOL_FLOW_NODE_TYPE_DESCRIPTION_ENABLED, but may be useful</span></div>
<div class="line"><span class="comment">     *     when converting from a different representation, like a</span></div>
<div class="line"><span class="comment">     *     language binding such as JavaScript or Python where one can</span></div>
<div class="line"><span class="comment">     *     get an object, hashmap or dictionary and convert straight</span></div>
<div class="line"><span class="comment">     *     to the C structure needed by the flow node type.</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * 3 - use helper sol_flow_node_named_options_init_from_strv() and</span></div>
<div class="line"><span class="comment">     *     sol_flow_node_options_new(), giving it an array of</span></div>
<div class="line"><span class="comment">     *     &quot;key=value&quot; strings. It will do the work described in #2</span></div>
<div class="line"><span class="comment">     *     for us, thus also depends on</span></div>
<div class="line"><span class="comment">     *     SOL_FLOW_NODE_TYPE_DESCRIPTION_ENABLED.</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * We&#39;ll use approach #3 since it is simpler. Language bindings</span></div>
<div class="line"><span class="comment">     * should go with option #2 and those that want to squeeze the</span></div>
<div class="line"><span class="comment">     * size and get performance should consider #1.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    err = <a name="a23"></a><a class="code" href="group__Flow.html#ga947324b91fa67d9411ef9eebce20d6ac">sol_flow_node_named_options_init_from_strv</a>(&amp;named_opts, *type, strv_opts);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        fputs(<span class="stringliteral">&quot;could not parse options for wallclock/minute\n&quot;</span>, stderr);</div>
<div class="line">        <a class="code" href="group__Mainloop.html#gab1deec1c7e4da3b7b8caeafe9369b816">sol_quit_with_code</a>(EXIT_FAILURE);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* convert the named options in the actual options structure */</span></div>
<div class="line">    err = <a name="a24"></a><a class="code" href="group__Flow.html#ga97a97cea2bc3e2e87de172c237c19a1a">sol_flow_node_options_new</a>(*type, &amp;named_opts, &amp;opts);</div>
<div class="line">    <a name="a25"></a><a class="code" href="group__Flow.html#gae5ff86bab1a1bab3fc2bfa6c541aafb4">sol_flow_node_named_options_fini</a>(&amp;named_opts);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        fputs(<span class="stringliteral">&quot;could not create options for wallclock/minute\n&quot;</span>, stderr);</div>
<div class="line">        <a class="code" href="group__Mainloop.html#gab1deec1c7e4da3b7b8caeafe9369b816">sol_quit_with_code</a>(EXIT_FAILURE);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Build the single node wrapping the wanted &#39;wallclock/minute&#39;.</span></div>
<div class="line"><span class="comment">     * For most matters the single node behaves like the inner node,</span></div>
<div class="line"><span class="comment">     * it will copy the descriptions and options.</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * The difference is that if you call sol_flow_send_packet() on</span></div>
<div class="line"><span class="comment">     * its input ports, it will forward the packet to the inner</span></div>
<div class="line"><span class="comment">     * node. Likewise, packets originated at the outgoing ports of the</span></div>
<div class="line"><span class="comment">     * inner node will be delivered through the process callback</span></div>
<div class="line"><span class="comment">     * (on_packet()) provided to the single node.</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * Note that ports you want to send (in) or receive (out) packets</span></div>
<div class="line"><span class="comment">     * must be connected with the connected_ports_in and</span></div>
<div class="line"><span class="comment">     * connected_ports_out parameters, or later with</span></div>
<div class="line"><span class="comment">     * sol_flow_single_connect_port_in() and</span></div>
<div class="line"><span class="comment">     * sol_flow_single_connect_port_out().</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <a class="code" href="single-node_8c.html#ae348e350b6f04a614d012cce3f77dc52">minutes</a> = <a name="a26"></a><a class="code" href="group__SingleFlow.html#gadde24d8571eeecac5f88999ab5bf51ba">sol_flow_single_new</a>(<span class="stringliteral">&quot;minutes&quot;</span>, *type, opts,</div>
<div class="line">        <a name="a27"></a><a class="code" href="group__SingleFlow.html#ga52b6661631d70dee8a3220b7d82f914c">SOL_FLOW_SINGLE_CONNECTIONS</a>(<a class="code" href="single-node_8c.html#a3485127700f912784610ea7410e236fe">minutes_port_enabled</a>),</div>
<div class="line">        <a class="code" href="group__SingleFlow.html#ga52b6661631d70dee8a3220b7d82f914c">SOL_FLOW_SINGLE_CONNECTIONS</a>(<a class="code" href="single-node_8c.html#a697fc2fd5b2a8596566e4e750842ada2">minutes_port_out</a>),</div>
<div class="line">        <a class="code" href="single-node_8c.html#a3651efcf0c3a5520e1a735baba4d52b9">on_minutes_packet</a>, NULL);</div>
<div class="line">    <a name="a28"></a><a class="code" href="group__Flow.html#ga0e8d0e9eac207024e07252535e73a27f">sol_flow_node_options_del</a>(*type, opts);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="a29"></a><a class="code" href="single-node_8c.html#af988688cd8be28426c68a9cdfb0c786c">create_seconds</a>(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structsol__flow__node__type.html">sol_flow_node_type</a> **type;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structsol__flow__node__named__options.html">sol_flow_node_named_options</a> named_opts = {};</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *strv_opts[] = {</div>
<div class="line">        <span class="stringliteral">&quot;send_initial_packet=1&quot;</span>,</div>
<div class="line">        NULL</div>
<div class="line">    };</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structsol__flow__node__options.html">sol_flow_node_options</a> *opts;</div>
<div class="line">    <span class="keywordtype">int</span> err;</div>
<div class="line"></div>
<div class="line">    err = <a class="code" href="group__Flow.html#gaeaa33e245d6e3b27f8fb1f5d6bffd664">sol_flow_get_node_type</a>(<span class="stringliteral">&quot;wallclock&quot;</span>,</div>
<div class="line">        SOL_FLOW_NODE_TYPE_WALLCLOCK_SECOND, &amp;type);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        fputs(<span class="stringliteral">&quot;could not find type: wallclock/second\n&quot;</span>, stderr);</div>
<div class="line">        <a class="code" href="group__Mainloop.html#gab1deec1c7e4da3b7b8caeafe9369b816">sol_quit_with_code</a>(EXIT_FAILURE);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="single-node_8c.html#a93ba8f94353d17acc7963a71aa390724">seconds_port_enabled</a> = sol_flow_node_find_port_in(*type, <span class="stringliteral">&quot;ENABLED&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="single-node_8c.html#a93ba8f94353d17acc7963a71aa390724">seconds_port_enabled</a> == UINT16_MAX) {</div>
<div class="line">        fputs(<span class="stringliteral">&quot;ERROR: couldn&#39;t find ouput port by name: ENABLED\n&quot;</span>, stderr);</div>
<div class="line">        <a class="code" href="group__Mainloop.html#gab1deec1c7e4da3b7b8caeafe9369b816">sol_quit_with_code</a>(EXIT_FAILURE);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="single-node_8c.html#a4c42c0f6740ecda28dc7e64721a748c6">seconds_port_out</a> = sol_flow_node_find_port_out(*type, <span class="stringliteral">&quot;OUT&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="single-node_8c.html#a4c42c0f6740ecda28dc7e64721a748c6">seconds_port_out</a> == UINT16_MAX) {</div>
<div class="line">        fputs(<span class="stringliteral">&quot;ERROR: couldn&#39;t find ouput port by name: OUT\n&quot;</span>, stderr);</div>
<div class="line">        <a class="code" href="group__Mainloop.html#gab1deec1c7e4da3b7b8caeafe9369b816">sol_quit_with_code</a>(EXIT_FAILURE);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    err = <a class="code" href="group__Flow.html#ga947324b91fa67d9411ef9eebce20d6ac">sol_flow_node_named_options_init_from_strv</a>(&amp;named_opts, *type, strv_opts);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        fputs(<span class="stringliteral">&quot;could not parse options for wallclock/second\n&quot;</span>, stderr);</div>
<div class="line">        <a class="code" href="group__Mainloop.html#gab1deec1c7e4da3b7b8caeafe9369b816">sol_quit_with_code</a>(EXIT_FAILURE);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    err = <a class="code" href="group__Flow.html#ga97a97cea2bc3e2e87de172c237c19a1a">sol_flow_node_options_new</a>(*type, &amp;named_opts, &amp;opts);</div>
<div class="line">    <a class="code" href="group__Flow.html#gae5ff86bab1a1bab3fc2bfa6c541aafb4">sol_flow_node_named_options_fini</a>(&amp;named_opts);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        fputs(<span class="stringliteral">&quot;could not create options for wallclock/second\n&quot;</span>, stderr);</div>
<div class="line">        <a class="code" href="group__Mainloop.html#gab1deec1c7e4da3b7b8caeafe9369b816">sol_quit_with_code</a>(EXIT_FAILURE);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="single-node_8c.html#ad78c3465d91d87d61a218acf991a77fc">seconds</a> = <a class="code" href="group__SingleFlow.html#gadde24d8571eeecac5f88999ab5bf51ba">sol_flow_single_new</a>(<span class="stringliteral">&quot;seconds&quot;</span>, *type, opts,</div>
<div class="line">        <a class="code" href="group__SingleFlow.html#ga52b6661631d70dee8a3220b7d82f914c">SOL_FLOW_SINGLE_CONNECTIONS</a>(<a class="code" href="single-node_8c.html#a93ba8f94353d17acc7963a71aa390724">seconds_port_enabled</a>),</div>
<div class="line">        <a class="code" href="group__SingleFlow.html#ga52b6661631d70dee8a3220b7d82f914c">SOL_FLOW_SINGLE_CONNECTIONS</a>(<a class="code" href="single-node_8c.html#a4c42c0f6740ecda28dc7e64721a748c6">seconds_port_out</a>),</div>
<div class="line">        <a class="code" href="single-node_8c.html#a69fe929a52d32ad268547620f74d4cd9">on_seconds_packet</a>, NULL);</div>
<div class="line">    <a class="code" href="group__Flow.html#ga0e8d0e9eac207024e07252535e73a27f">sol_flow_node_options_del</a>(*type, opts);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="a30"></a><a class="code" href="browse_8c.html#a8f65ca9f5a72be7fe776126fc632f8a9">startup</a>(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="single-node_8c.html#a628d35a3d6e3e51f4a89fe34b5b9f499">create_minutes</a>();</div>
<div class="line">    <a class="code" href="single-node_8c.html#af988688cd8be28426c68a9cdfb0c786c">create_seconds</a>();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="a31"></a><a class="code" href="browse_8c.html#af80085e2fde103b0fcdf58fcab027e47">shutdown</a>(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <a name="a32"></a><a class="code" href="group__Flow.html#gafdddc9d12a1dc9fec29c77a1c0e43eef">sol_flow_node_del</a>(<a class="code" href="single-node_8c.html#ae348e350b6f04a614d012cce3f77dc52">minutes</a>);</div>
<div class="line">    <a class="code" href="group__Flow.html#gafdddc9d12a1dc9fec29c77a1c0e43eef">sol_flow_node_del</a>(<a class="code" href="single-node_8c.html#ad78c3465d91d87d61a218acf991a77fc">seconds</a>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a name="a33"></a><a class="code" href="group__Mainloop.html#ga54818bc87ca55fe50e3732f52b56e009">SOL_MAIN_DEFAULT</a>(<a class="code" href="browse_8c.html#a8f65ca9f5a72be7fe776126fc632f8a9">startup</a>, <a class="code" href="browse_8c.html#af80085e2fde103b0fcdf58fcab027e47">shutdown</a>);</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- HTML footer for doxygen 1.8.9.1-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
<a href="http://solettaproject.github.io/docs/">Full online documentation</a> | 
<a href="index.html">C API Index</a>
</small></address>
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
