<!-- HTML header for doxygen 1.8.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Soletta™ Framework: /src/samples/iio+network/iio-gyroscope-console-and-mqtt-publish.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Soletta™ Framework
   </div>
   <div id="projectbrief">
   Framework for making IoT devices<br /><br />
   <small>
   <a href="http://solettaproject.github.io/docs/">Full online documentation</a> | 
   <a href="index.html">C API Index</a>
   </small><br />
   </div>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">/src/samples/iio+network/iio-gyroscope-console-and-mqtt-publish.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This file is part of the Soletta (TM) Project</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2016 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></div>
<div class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></div>
<div class="line"><span class="comment"> * You may obtain a copy of the License at</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     http://www.apache.org/licenses/LICENSE-2.0</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></div>
<div class="line"><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></div>
<div class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></div>
<div class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></div>
<div class="line"><span class="comment"> * limitations under the License.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#include &lt;limits.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sol-iio_8h.html">sol-iio.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sol-log_8h.html">sol-log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sol-mainloop_8h.html">sol-mainloop.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sol-mqtt_8h.html">sol-mqtt.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* comment out following if you don&#39;t plan to use calibration and denoise */</span></div>
<div class="line"><span class="preprocessor">#define GYRO_CALIBRATE</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DENOISE_MEDIAN</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifdef GYRO_CALIBRATE</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;math.h&gt;</span></div>
<div class="line"><span class="preprocessor">#define GYRO_MAX_ERR 0.05</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define GYRO_DS_SIZE 100</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifdef DENOISE_MEDIAN</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define GYRO_DENOISE_MAX_SAMPLES 5</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define GYRO_DENOISE_NUM_FIELDS 3</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define GYRO_DROP_SAMPLES 5 </span><span class="comment">/* Drop first few gyro samples for noisy sensor */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifdef GYRO_CALIBRATE</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structgyro__cal.html">gyro_cal</a> {</div>
<div class="line">    <span class="keywordtype">bool</span> <a name="a1"></a><a class="code" href="structgyro__cal.html#abef5927f17e98bca6dd97be78febaa5b">calibrated</a>;</div>
<div class="line">    <span class="keywordtype">double</span> <a name="a2"></a><a class="code" href="structgyro__cal.html#ae91793aeb3abe7a0aa7770a662ee5241">bias_x</a>, <a name="a3"></a><a class="code" href="structgyro__cal.html#ac13b0a2d23b1ae4a35396f744c7ed029">bias_y</a>, <a name="a4"></a><a class="code" href="structgyro__cal.html#a44578ebd6db9daad82d467de5d3be037">bias_z</a>;</div>
<div class="line">    <span class="keywordtype">int</span> <a name="a5"></a><a class="code" href="structgyro__cal.html#a77b56d2e67c055761610b302746d08dd">count</a>;</div>
<div class="line">    <span class="keywordtype">double</span> <a name="a6"></a><a class="code" href="structgyro__cal.html#a1011fba64d3aed56f7479bc81f3fadff">min_x</a>;</div>
<div class="line">    <span class="keywordtype">double</span> <a name="a7"></a><a class="code" href="structgyro__cal.html#a63b22e7974eb97a0deaee4a60734b944">min_y</a>;</div>
<div class="line">    <span class="keywordtype">double</span> <a name="a8"></a><a class="code" href="structgyro__cal.html#a371dba54a6417ccad5c6ad9350d62182">min_z</a>;</div>
<div class="line">    <span class="keywordtype">double</span> <a name="a9"></a><a class="code" href="structgyro__cal.html#a961bff597350d6b600bc3ee07dc55a3d">max_x</a>;</div>
<div class="line">    <span class="keywordtype">double</span> <a name="a10"></a><a class="code" href="structgyro__cal.html#abe1b369cb9d7c7433c2dd2eea7f7892f">max_y</a>;</div>
<div class="line">    <span class="keywordtype">double</span> <a name="a11"></a><a class="code" href="structgyro__cal.html#a6b6dfc7e9d7b84a321df9ef38dfcbbc5">max_z</a>;</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifdef DENOISE_MEDIAN</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">struct </span><a name="_a12"></a><a class="code" href="structfilter__median.html">filter_median</a> {</div>
<div class="line">    <span class="keywordtype">double</span> *<a name="a13"></a><a class="code" href="structfilter__median.html#a1fbf976fcf54b6d6865e60f143518cf4">buff</a>;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a name="a14"></a><a class="code" href="structfilter__median.html#a223412541ddb04ff040bb7e53d44e777">idx</a>;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a name="a15"></a><a class="code" href="structfilter__median.html#a236441a297e05e216f6746df1e5cecd3">count</a>;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a name="a16"></a><a class="code" href="structfilter__median.html#a2bceb8907818e0f9d7dbd7d89d42cb9e">sample_size</a>;</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">struct </span><a name="_a17"></a><a class="code" href="structiio__gyroscope__data.html">iio_gyroscope_data</a> {</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="group__IIO.html#ga1bffac49f07fd6fa7db003754b2ecb72">sol_iio_channel</a> *<a name="a18"></a><a class="code" href="structiio__gyroscope__data.html#a79ae89202d5868dda5b80addf301b7c8">channel_x</a>;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="group__IIO.html#ga1bffac49f07fd6fa7db003754b2ecb72">sol_iio_channel</a> *<a name="a19"></a><a class="code" href="structiio__gyroscope__data.html#a5ed8c9d3cd196905fa241b065685314f">channel_y</a>;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="group__IIO.html#ga1bffac49f07fd6fa7db003754b2ecb72">sol_iio_channel</a> *<a name="a20"></a><a class="code" href="structiio__gyroscope__data.html#a78bfda207c4021b308202d0879663391">channel_z</a>;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="group__MQTT.html#gaf885402d6d32451bbd8c865453d5fa28">sol_mqtt</a> *<a name="a21"></a><a class="code" href="structiio__gyroscope__data.html#a4f719ca3f4feb3f5f1c81f3bb6d46e9a">mqtt</a>;</div>
<div class="line">    <span class="keywordtype">char</span> *<a name="a22"></a><a class="code" href="structiio__gyroscope__data.html#abf9faca15bb614f832d7738614c8e58d">mqtt_topic</a>;</div>
<div class="line"><span class="preprocessor">#ifdef GYRO_CALIBRATE</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keyword">struct </span><a class="code" href="structgyro__cal.html">gyro_cal</a> <a name="a23"></a><a class="code" href="structiio__gyroscope__data.html#a77db7e634c9b4bd3d4071d703553038c">cal_data</a>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#ifdef DENOISE_MEDIAN</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keyword">struct </span><a class="code" href="structfilter__median.html">filter_median</a> <a name="a24"></a><a class="code" href="structiio__gyroscope__data.html#a958244f564c12cd54a169f485bb9bc80">filter_data</a>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a name="a25"></a><a class="code" href="structiio__gyroscope__data.html#a23d16effb5e75a9ccd49120576b3e555">drop_samples_count</a>;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="group__Mainloop.html#ga40dddc147a0d6370aeb8219a90b56596">sol_timeout</a> *<a name="a26"></a><a class="code" href="browse_8c.html#ab3606a13f5d028aa43f82d8989b84980">timeout</a>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span></div>
<div class="line"><a name="a27"></a><a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#ab84721156c74dee55007098b1a72404e">try_reconnect</a>(<span class="keywordtype">void</span> *data)</div>
<div class="line">{</div>
<div class="line">    <a name="a28"></a><a class="code" href="group__Log.html#gad3905aefbce3545adfc28d98defef899">SOL_INF</a>(<span class="stringliteral">&quot;Try reconnect...&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> <a name="a29"></a><a class="code" href="group__MQTT.html#ga9534f5d474232ae52b6baffa17e15698">sol_mqtt_reconnect</a>((<span class="keyword">struct</span> <a class="code" href="group__MQTT.html#gaf885402d6d32451bbd8c865453d5fa28">sol_mqtt</a> *)data) != 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="a30"></a><a class="code" href="browse_8c.html#a896853ca3a8646c8a157243b09b03db5">on_connect</a>(<span class="keywordtype">void</span> *data, <span class="keyword">struct</span> <a class="code" href="group__MQTT.html#gaf885402d6d32451bbd8c865453d5fa28">sol_mqtt</a> *mqtt)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a31"></a><a class="code" href="group__MQTT.html#ga3b44bc46b3a0ef7be8854a5011554bbf">sol_mqtt_get_connection_status</a>(mqtt) == <a name="a32"></a><a class="code" href="group__MQTT.html#ggab4ca3e13df83d0a379bbb2efc37fac11a7ab79d8f453865c85060a6c36a724d64">SOL_MQTT_CONNECTED</a>) {</div>
<div class="line">        <a class="code" href="group__Log.html#gad3905aefbce3545adfc28d98defef899">SOL_INF</a>(<span class="stringliteral">&quot;Connected...&quot;</span>);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <a name="a33"></a><a class="code" href="group__Log.html#ga5d9529e9746395acc2cd96a28ffa1c28">SOL_WRN</a>(<span class="stringliteral">&quot;Unable to connect, retrying...&quot;</span>);</div>
<div class="line">        <a class="code" href="browse_8c.html#ab3606a13f5d028aa43f82d8989b84980">timeout</a> = <a name="a34"></a><a class="code" href="group__Mainloop.html#ga9d0cd6af9dab4da3002e5cd596ce604f">sol_timeout_add</a>(1000, <a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#ab84721156c74dee55007098b1a72404e">try_reconnect</a>, mqtt);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="a35"></a><a class="code" href="browse_8c.html#a4f1ee1d8963297187f5b28ae83940600">on_disconnect</a>(<span class="keywordtype">void</span> *data, <span class="keyword">struct</span> <a class="code" href="group__MQTT.html#gaf885402d6d32451bbd8c865453d5fa28">sol_mqtt</a> *mqtt)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group__Log.html#gad3905aefbce3545adfc28d98defef899">SOL_INF</a>(<span class="stringliteral">&quot;Disconnect...&quot;</span>);</div>
<div class="line">    <a class="code" href="group__Mainloop.html#ga9d0cd6af9dab4da3002e5cd596ce604f">sol_timeout_add</a>(1000, <a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#ab84721156c74dee55007098b1a72404e">try_reconnect</a>, mqtt);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef GYRO_CALIBRATE</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="a36"></a><a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a39b32d4b07905139afb451c9e2e85832">reset_calibrate</a>(<span class="keyword">struct</span> <a class="code" href="structgyro__cal.html">gyro_cal</a> *cal_data)</div>
<div class="line">{</div>
<div class="line">    cal_data-&gt;<a class="code" href="structgyro__cal.html#abef5927f17e98bca6dd97be78febaa5b">calibrated</a> = <span class="keyword">false</span>;</div>
<div class="line">    cal_data-&gt;<a class="code" href="structgyro__cal.html#a77b56d2e67c055761610b302746d08dd">count</a> = 0;</div>
<div class="line">    cal_data-&gt;<a class="code" href="structgyro__cal.html#ae91793aeb3abe7a0aa7770a662ee5241">bias_x</a> = cal_data-&gt;<a class="code" href="structgyro__cal.html#ac13b0a2d23b1ae4a35396f744c7ed029">bias_y</a> = cal_data-&gt;<a class="code" href="structgyro__cal.html#a44578ebd6db9daad82d467de5d3be037">bias_z</a> = 0;</div>
<div class="line">    cal_data-&gt;<a class="code" href="structgyro__cal.html#a1011fba64d3aed56f7479bc81f3fadff">min_x</a> = cal_data-&gt;<a class="code" href="structgyro__cal.html#a63b22e7974eb97a0deaee4a60734b944">min_y</a> = cal_data-&gt;<a class="code" href="structgyro__cal.html#a371dba54a6417ccad5c6ad9350d62182">min_z</a> = 1.0;</div>
<div class="line">    cal_data-&gt;<a class="code" href="structgyro__cal.html#a961bff597350d6b600bc3ee07dc55a3d">max_x</a> = cal_data-&gt;<a class="code" href="structgyro__cal.html#abe1b369cb9d7c7433c2dd2eea7f7892f">max_y</a> = cal_data-&gt;<a class="code" href="structgyro__cal.html#a6b6dfc7e9d7b84a321df9ef38dfcbbc5">max_z</a> = -1.0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span></div>
<div class="line"><a name="a37"></a><a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a299ab427623289780bf3a3ebec8b386c">gyro_collect</a>(<span class="keyword">struct</span> <a class="code" href="structgyro__cal.html">gyro_cal</a> *cal_data, <span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y, <span class="keywordtype">double</span> z)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Analyze gyroscope data */</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (fabs(x) &gt;= 1 || fabs(y) &gt;= 1 || fabs(z) &gt;= 1) {</div>
<div class="line">        <span class="comment">/* We&#39;re supposed to be standing still ; start over */</span></div>
<div class="line">        <a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a39b32d4b07905139afb451c9e2e85832">reset_calibrate</a>(cal_data);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">/* Uncalibrated */</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Thanks to https://github.com/01org/android-iio-sensors-hal</span></div>
<div class="line"><span class="comment">     * for calibration algorithm</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">if</span> (cal_data-&gt;<a class="code" href="structgyro__cal.html#a77b56d2e67c055761610b302746d08dd">count</a> &lt; <a name="a38"></a><a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a55bb328e3dfc143c20df0af84a33e70c">GYRO_DS_SIZE</a>) {</div>
<div class="line">        <span class="keywordflow">if</span> (x &lt; cal_data-&gt;min_x)</div>
<div class="line">            cal_data-&gt;<a class="code" href="structgyro__cal.html#a1011fba64d3aed56f7479bc81f3fadff">min_x</a> = x;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (y &lt; cal_data-&gt;min_y)</div>
<div class="line">            cal_data-&gt;<a class="code" href="structgyro__cal.html#a63b22e7974eb97a0deaee4a60734b944">min_y</a> = y;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (z &lt; cal_data-&gt;min_z)</div>
<div class="line">            cal_data-&gt;<a class="code" href="structgyro__cal.html#a371dba54a6417ccad5c6ad9350d62182">min_z</a> = z;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (x &gt; cal_data-&gt;<a class="code" href="structgyro__cal.html#a961bff597350d6b600bc3ee07dc55a3d">max_x</a>)</div>
<div class="line">            cal_data-&gt;<a class="code" href="structgyro__cal.html#a961bff597350d6b600bc3ee07dc55a3d">max_x</a> = x;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (y &gt; cal_data-&gt;<a class="code" href="structgyro__cal.html#abe1b369cb9d7c7433c2dd2eea7f7892f">max_y</a>)</div>
<div class="line">            cal_data-&gt;<a class="code" href="structgyro__cal.html#abe1b369cb9d7c7433c2dd2eea7f7892f">max_y</a> = y;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (z &gt; cal_data-&gt;<a class="code" href="structgyro__cal.html#a6b6dfc7e9d7b84a321df9ef38dfcbbc5">max_z</a>)</div>
<div class="line">            cal_data-&gt;<a class="code" href="structgyro__cal.html#a6b6dfc7e9d7b84a321df9ef38dfcbbc5">max_z</a> = z;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (fabs(cal_data-&gt;<a class="code" href="structgyro__cal.html#a961bff597350d6b600bc3ee07dc55a3d">max_x</a> - cal_data-&gt;<a class="code" href="structgyro__cal.html#a1011fba64d3aed56f7479bc81f3fadff">min_x</a>) &lt;= <a name="a39"></a><a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a346be10e24c66e9798226d304f21fe1b">GYRO_MAX_ERR</a> &amp;&amp;</div>
<div class="line">            fabs(cal_data-&gt;<a class="code" href="structgyro__cal.html#abe1b369cb9d7c7433c2dd2eea7f7892f">max_y</a> - cal_data-&gt;<a class="code" href="structgyro__cal.html#a63b22e7974eb97a0deaee4a60734b944">min_y</a>) &lt;= <a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a346be10e24c66e9798226d304f21fe1b">GYRO_MAX_ERR</a> &amp;&amp;</div>
<div class="line">            fabs(cal_data-&gt;<a class="code" href="structgyro__cal.html#a6b6dfc7e9d7b84a321df9ef38dfcbbc5">max_z</a> - cal_data-&gt;<a class="code" href="structgyro__cal.html#a371dba54a6417ccad5c6ad9350d62182">min_z</a>) &lt;= <a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a346be10e24c66e9798226d304f21fe1b">GYRO_MAX_ERR</a>)</div>
<div class="line">            cal_data-&gt;<a class="code" href="structgyro__cal.html#a77b56d2e67c055761610b302746d08dd">count</a>++; <span class="comment">/* One more conformant sample */</span></div>
<div class="line">        <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="comment">/* Out of spec sample ; start over */</span></div>
<div class="line">            <a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a39b32d4b07905139afb451c9e2e85832">reset_calibrate</a>(cal_data);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">/* Still uncalibrated */</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* We got enough stable samples to estimate gyroscope bias */</span></div>
<div class="line">    cal_data-&gt;<a class="code" href="structgyro__cal.html#ae91793aeb3abe7a0aa7770a662ee5241">bias_x</a> = (cal_data-&gt;<a class="code" href="structgyro__cal.html#a961bff597350d6b600bc3ee07dc55a3d">max_x</a> + cal_data-&gt;<a class="code" href="structgyro__cal.html#a1011fba64d3aed56f7479bc81f3fadff">min_x</a>) / 2;</div>
<div class="line">    cal_data-&gt;<a class="code" href="structgyro__cal.html#ac13b0a2d23b1ae4a35396f744c7ed029">bias_y</a> = (cal_data-&gt;<a class="code" href="structgyro__cal.html#abe1b369cb9d7c7433c2dd2eea7f7892f">max_y</a> + cal_data-&gt;<a class="code" href="structgyro__cal.html#a63b22e7974eb97a0deaee4a60734b944">min_y</a>) / 2;</div>
<div class="line">    cal_data-&gt;<a class="code" href="structgyro__cal.html#a44578ebd6db9daad82d467de5d3be037">bias_z</a> = (cal_data-&gt;<a class="code" href="structgyro__cal.html#a6b6dfc7e9d7b84a321df9ef38dfcbbc5">max_z</a> + cal_data-&gt;<a class="code" href="structgyro__cal.html#a371dba54a6417ccad5c6ad9350d62182">min_z</a>) / 2;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">/* Calibrated! */</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="a40"></a><a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a876ed237f70f4da08116644c05958953">clamp_gyro_readings_to_zero</a>(<span class="keyword">struct</span> <a class="code" href="structgyro__cal.html">gyro_cal</a> *cal_data, <span class="keywordtype">double</span> *x, <span class="keywordtype">double</span> *y, <span class="keywordtype">double</span> *z)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">double</span> near_zero;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* If we&#39;re calibrated, don&#39;t filter out as much */</span></div>
<div class="line">    <span class="keywordflow">if</span> (cal_data-&gt;<a class="code" href="structgyro__cal.html#abef5927f17e98bca6dd97be78febaa5b">calibrated</a>)</div>
<div class="line">        near_zero = 0.02; <span class="comment">/* rad/s */</span></div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        near_zero = 0.1;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* If motion on all axes is small enough */</span></div>
<div class="line">    <span class="keywordflow">if</span> (fabs(*x) &lt; near_zero &amp;&amp; fabs(*y) &lt; near_zero &amp;&amp; fabs(*z) &lt; near_zero) {</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Report that we&#39;re not moving at all... but not exactly zero</span></div>
<div class="line"><span class="comment">         * as composite sensors(orientation, rotation vector) don&#39;t seem</span></div>
<div class="line"><span class="comment">         * to react very well to it.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line"></div>
<div class="line">        *x *= 0.000001;</div>
<div class="line">        *y *= 0.000001;</div>
<div class="line">        *z *= 0.000001;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifdef DENOISE_MEDIAN</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span></div>
<div class="line"><a name="a41"></a><a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a92040cf5e2fc7a8209c1d60896fe68a5">partition</a>(<span class="keywordtype">double</span> *list, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> left, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> right, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pivot_index)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> store_index = left;</div>
<div class="line">    <span class="keywordtype">double</span> aux;</div>
<div class="line">    <span class="keywordtype">double</span> pivot_value = list[pivot_index];</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Swap list[pivotIndex] and list[right] */</span></div>
<div class="line">    aux = list[pivot_index];</div>
<div class="line">    list[pivot_index] = list[right];</div>
<div class="line">    list[right] = aux;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = left; i &lt; right; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (list[i] &lt; pivot_value) {</div>
<div class="line">            <span class="comment">/* Swap list[store_index] and list[i] */</span></div>
<div class="line">            aux = list[store_index];</div>
<div class="line">            list[store_index] = list[i];</div>
<div class="line">            list[i] = aux;</div>
<div class="line">            store_index++;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Swap list[right] and list[store_index] */</span></div>
<div class="line">    aux = list[right];</div>
<div class="line">    list[right] = list[store_index];</div>
<div class="line">    list[store_index] = aux;</div>
<div class="line">    <span class="keywordflow">return</span> store_index;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">double</span></div>
<div class="line"><a name="a42"></a><a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a1b105b9698a470b705e668c94bae3d96">median</a>(<span class="keywordtype">double</span> *<a name="a43"></a><a class="code" href="echo-server_8c.html#ab23c6c589bba8a212327d25df4e12d6b">queue</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* http://en.wikipedia.org/wiki/Quickselect */</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> left = 0;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> right = size - 1;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pivot_index;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> median_index = (right / 2);</div>
<div class="line">    <span class="keywordtype">double</span> temp[size];</div>
<div class="line"></div>
<div class="line">    memcpy(temp, queue, size * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* If the list has only one element return it */</span></div>
<div class="line">    <span class="keywordflow">if</span> (left == right)</div>
<div class="line">        <span class="keywordflow">return</span> temp[left];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (left &lt; right) {</div>
<div class="line">        pivot_index = (left + right) / 2;</div>
<div class="line">        pivot_index = <a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a92040cf5e2fc7a8209c1d60896fe68a5">partition</a>(temp, left, right, pivot_index);</div>
<div class="line">        <span class="keywordflow">if</span> (pivot_index == median_index)</div>
<div class="line">            <span class="keywordflow">return</span> temp[median_index];</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pivot_index &gt; median_index)</div>
<div class="line">            right = pivot_index - 1;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            left = pivot_index + 1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> temp[left];</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="a44"></a><a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#ab202389fe3a406f63227e182a6dda635">denoise_median</a>(<span class="keyword">struct</span> <a class="code" href="structfilter__median.html">filter_median</a> *filter_data, <span class="keywordtype">double</span> *x, <span class="keywordtype">double</span> *y, <span class="keywordtype">double</span> *z)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Thanks to https://github.com/01org/android-iio-sensors-hal</span></div>
<div class="line"><span class="comment">     * for denoise algorithm</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (filter_data-&gt;<a class="code" href="structfilter__median.html#a236441a297e05e216f6746df1e5cecd3">count</a> &lt; filter_data-&gt;<a class="code" href="structfilter__median.html#a2bceb8907818e0f9d7dbd7d89d42cb9e">sample_size</a>)</div>
<div class="line">        filter_data-&gt;<a class="code" href="structfilter__median.html#a236441a297e05e216f6746df1e5cecd3">count</a>++;</div>
<div class="line"></div>
<div class="line">    offset = 0;</div>
<div class="line">    filter_data-&gt;<a class="code" href="structfilter__median.html#a1fbf976fcf54b6d6865e60f143518cf4">buff</a>[offset + filter_data-&gt;<a class="code" href="structfilter__median.html#a223412541ddb04ff040bb7e53d44e777">idx</a>] = *x;</div>
<div class="line">    *x = <a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a1b105b9698a470b705e668c94bae3d96">median</a>(filter_data-&gt;<a class="code" href="structfilter__median.html#a1fbf976fcf54b6d6865e60f143518cf4">buff</a> + offset, filter_data-&gt;<a class="code" href="structfilter__median.html#a236441a297e05e216f6746df1e5cecd3">count</a>);</div>
<div class="line"></div>
<div class="line">    offset = filter_data-&gt;<a class="code" href="structfilter__median.html#a2bceb8907818e0f9d7dbd7d89d42cb9e">sample_size</a> * 1;</div>
<div class="line">    filter_data-&gt;<a class="code" href="structfilter__median.html#a1fbf976fcf54b6d6865e60f143518cf4">buff</a>[offset + filter_data-&gt;<a class="code" href="structfilter__median.html#a223412541ddb04ff040bb7e53d44e777">idx</a>] = *y;</div>
<div class="line">    *y = <a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a1b105b9698a470b705e668c94bae3d96">median</a>(filter_data-&gt;<a class="code" href="structfilter__median.html#a1fbf976fcf54b6d6865e60f143518cf4">buff</a> + offset, filter_data-&gt;<a class="code" href="structfilter__median.html#a236441a297e05e216f6746df1e5cecd3">count</a>);</div>
<div class="line"></div>
<div class="line">    offset = filter_data-&gt;<a class="code" href="structfilter__median.html#a2bceb8907818e0f9d7dbd7d89d42cb9e">sample_size</a> * 2;</div>
<div class="line">    filter_data-&gt;<a class="code" href="structfilter__median.html#a1fbf976fcf54b6d6865e60f143518cf4">buff</a>[offset + filter_data-&gt;<a class="code" href="structfilter__median.html#a223412541ddb04ff040bb7e53d44e777">idx</a>] = *z;</div>
<div class="line">    *z = <a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a1b105b9698a470b705e668c94bae3d96">median</a>(filter_data-&gt;<a class="code" href="structfilter__median.html#a1fbf976fcf54b6d6865e60f143518cf4">buff</a> + offset, filter_data-&gt;<a class="code" href="structfilter__median.html#a236441a297e05e216f6746df1e5cecd3">count</a>);</div>
<div class="line"></div>
<div class="line">    filter_data-&gt;<a class="code" href="structfilter__median.html#a223412541ddb04ff040bb7e53d44e777">idx</a> = (filter_data-&gt;<a class="code" href="structfilter__median.html#a223412541ddb04ff040bb7e53d44e777">idx</a> + 1) % filter_data-&gt;<a class="code" href="structfilter__median.html#a2bceb8907818e0f9d7dbd7d89d42cb9e">sample_size</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="a45"></a><a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a4f29673b4a00b8c6740301f425f4eb81">iio_gyroscope_reader_cb</a>(<span class="keywordtype">void</span> *data, <span class="keyword">struct</span> <a class="code" href="group__IIO.html#gac894b251e6ef8abcfeb9f6134870fcff">sol_iio_device</a> *device)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> r;</div>
<div class="line">    <span class="keywordtype">char</span> buffer[128];</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structiio__gyroscope__data.html">iio_gyroscope_data</a> *gyro_data = data;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a46"></a><a class="code" href="structsol__direction__vector.html">sol_direction_vector</a> out;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a47"></a><a class="code" href="structsol__buffer.html">sol_buffer</a> payload;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a48"></a><a class="code" href="structsol__mqtt__message.html">sol_mqtt_message</a> mqtt_message;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef GYRO_CALIBRATE</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keyword">struct </span><a class="code" href="structgyro__cal.html">gyro_cal</a> *cal_data = &amp;(gyro_data-&gt;<a class="code" href="structiio__gyroscope__data.html#a77db7e634c9b4bd3d4071d703553038c">cal_data</a>);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#ifdef DENOISE_MEDIAN</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keyword">struct </span><a class="code" href="structfilter__median.html">filter_median</a> *filter_data = &amp;(gyro_data-&gt;<a class="code" href="structiio__gyroscope__data.html#a958244f564c12cd54a169f485bb9bc80">filter_data</a>);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    r = <a name="a49"></a><a class="code" href="group__IIO.html#ga313c4e6ddf45510ee85fe4e7d93445c4">sol_iio_read_channel_value</a>(gyro_data-&gt;<a class="code" href="structiio__gyroscope__data.html#a79ae89202d5868dda5b80addf301b7c8">channel_x</a>, &amp;out.x);</div>
<div class="line">    <a name="a50"></a><a class="code" href="group__Log.html#ga6b76857beab196e724ba7486e411617b">SOL_INT_CHECK_GOTO</a>(r, &lt; 0, error);</div>
<div class="line"></div>
<div class="line">    r = <a class="code" href="group__IIO.html#ga313c4e6ddf45510ee85fe4e7d93445c4">sol_iio_read_channel_value</a>(gyro_data-&gt;<a class="code" href="structiio__gyroscope__data.html#a5ed8c9d3cd196905fa241b065685314f">channel_y</a>, &amp;out.y);</div>
<div class="line">    <a class="code" href="group__Log.html#ga6b76857beab196e724ba7486e411617b">SOL_INT_CHECK_GOTO</a>(r, &lt; 0, error);</div>
<div class="line"></div>
<div class="line">    r = <a class="code" href="group__IIO.html#ga313c4e6ddf45510ee85fe4e7d93445c4">sol_iio_read_channel_value</a>(gyro_data-&gt;<a class="code" href="structiio__gyroscope__data.html#a78bfda207c4021b308202d0879663391">channel_z</a>, &amp;out.z);</div>
<div class="line">    <a class="code" href="group__Log.html#ga6b76857beab196e724ba7486e411617b">SOL_INT_CHECK_GOTO</a>(r, &lt; 0, error);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * For noisy sensors drop a few samples to make sure we have at least</span></div>
<div class="line"><span class="comment">     * GYRO_DROP_SAMPLES events in the filtering queue.</span></div>
<div class="line"><span class="comment">     * This improves mean and std dev.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">if</span> (gyro_data-&gt;<a class="code" href="structiio__gyroscope__data.html#a23d16effb5e75a9ccd49120576b3e555">drop_samples_count</a> &lt; <a name="a51"></a><a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a23c66cde0bef159f1951f4d975c3916c">GYRO_DROP_SAMPLES</a>) {</div>
<div class="line">        gyro_data-&gt;<a class="code" href="structiio__gyroscope__data.html#a23d16effb5e75a9ccd49120576b3e555">drop_samples_count</a>++;</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a name="a52"></a><a class="code" href="group__IIO.html#ga3c8dd11e546fdf6d4b02ca3c8195c43c">sol_iio_mount_calibration</a>(device, &amp;out);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef GYRO_CALIBRATE</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">if</span> (cal_data-&gt;<a class="code" href="structgyro__cal.html#abef5927f17e98bca6dd97be78febaa5b">calibrated</a> == <span class="keyword">false</span>)</div>
<div class="line">        cal_data-&gt;<a class="code" href="structgyro__cal.html#abef5927f17e98bca6dd97be78febaa5b">calibrated</a> = <a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a299ab427623289780bf3a3ebec8b386c">gyro_collect</a>(cal_data, out.x, out.y, out.z);</div>
<div class="line"></div>
<div class="line">    out.x = out.x - cal_data-&gt;<a class="code" href="structgyro__cal.html#ae91793aeb3abe7a0aa7770a662ee5241">bias_x</a>;</div>
<div class="line">    out.y = out.y - cal_data-&gt;<a class="code" href="structgyro__cal.html#ac13b0a2d23b1ae4a35396f744c7ed029">bias_y</a>;</div>
<div class="line">    out.z = out.z - cal_data-&gt;<a class="code" href="structgyro__cal.html#a44578ebd6db9daad82d467de5d3be037">bias_z</a>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifdef DENOISE_MEDIAN</span></div>
<div class="line"><span class="preprocessor"></span>    <a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#ab202389fe3a406f63227e182a6dda635">denoise_median</a>(filter_data, &amp;out.x, &amp;out.y, &amp;out.z);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifdef GYRO_CALIBRATE</span></div>
<div class="line"><span class="preprocessor"></span>    <a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a876ed237f70f4da08116644c05958953">clamp_gyro_readings_to_zero</a>(cal_data, &amp;out.x, &amp;out.y, &amp;out.z);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifdef GYRO_CALIBRATE</span></div>
<div class="line"><span class="preprocessor"></span>    snprintf(buffer, <span class="keyword">sizeof</span>(buffer) - 1, <span class="stringliteral">&quot;%f\t%f\t%f\t[rad/sec]\t(%s)&quot;</span>, out.x, out.y, out.z,</div>
<div class="line">        (cal_data-&gt;<a class="code" href="structgyro__cal.html#abef5927f17e98bca6dd97be78febaa5b">calibrated</a> ? <span class="stringliteral">&quot;Calibrated&quot;</span> : <span class="stringliteral">&quot;Not calibrated&quot;</span>));</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    snprintf(buffer, <span class="keyword">sizeof</span>(buffer) - 1, <span class="stringliteral">&quot;%f\t%f\t%f\t[rad/sec]\t(Calibration disabled)&quot;</span>,</div>
<div class="line">        out.x, out.y, out.z);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    printf(<span class="stringliteral">&quot;%s\n&quot;</span>, buffer);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (gyro_data-&gt;<a class="code" href="structiio__gyroscope__data.html#a4f719ca3f4feb3f5f1c81f3bb6d46e9a">mqtt</a> == NULL) {</div>
<div class="line">        <a class="code" href="group__Log.html#ga5d9529e9746395acc2cd96a28ffa1c28">SOL_WRN</a>(<span class="stringliteral">&quot;mqtt is null&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group__MQTT.html#ga3b44bc46b3a0ef7be8854a5011554bbf">sol_mqtt_get_connection_status</a>(gyro_data-&gt;<a class="code" href="structiio__gyroscope__data.html#a4f719ca3f4feb3f5f1c81f3bb6d46e9a">mqtt</a>) == <a class="code" href="group__MQTT.html#ggab4ca3e13df83d0a379bbb2efc37fac11a7ab79d8f453865c85060a6c36a724d64">SOL_MQTT_CONNECTED</a>) {</div>
<div class="line"></div>
<div class="line">        payload = <a name="a53"></a><a class="code" href="group__Buffer.html#gadc43c29b2c14ae0537025619804d46fa">SOL_BUFFER_INIT_CONST</a>(buffer, strlen(buffer));</div>
<div class="line"></div>
<div class="line">        mqtt_message = (<span class="keyword">struct </span><a class="code" href="structsol__mqtt__message.html">sol_mqtt_message</a>){</div>
<div class="line">            <a name="a54"></a><a class="code" href="group__Mainloop.html#ga794a88f51470a85bb21279b32cc570ca">SOL_SET_API_VERSION</a>(.<a name="a55"></a><a class="code" href="structsol__mqtt__message.html#ad4e6a178b8981cf02b116a5706fba6ed">api_version</a> = <a name="a56"></a><a class="code" href="sol-mqtt_8h.html#a11a68e445488fa1702b807665425cc54">SOL_MQTT_MESSAGE_API_VERSION</a>, )</div>
<div class="line">            .topic = gyro_data-&gt;<a class="code" href="structiio__gyroscope__data.html#abf9faca15bb614f832d7738614c8e58d">mqtt_topic</a>,</div>
<div class="line">            .payload = &amp;<a name="a57"></a><a class="code" href="structsol__mqtt__message.html#aa3b59c6c017e1a924900c4253ee802ce">payload</a>,</div>
<div class="line">            .qos = <a name="a58"></a><a class="code" href="group__MQTT.html#gga32f1d2f2917d78cb4dc37e73382e0115a33283b291b894dfaf53aa149a0660fe7">SOL_MQTT_QOS_EXACTLY_ONCE</a>,</div>
<div class="line">            .retain = <span class="keyword">false</span>,</div>
<div class="line">        };</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a59"></a><a class="code" href="group__MQTT.html#gaa945624a84eb8e537af9094ad37fe47e">sol_mqtt_publish</a>(gyro_data-&gt;<a class="code" href="structiio__gyroscope__data.html#a4f719ca3f4feb3f5f1c81f3bb6d46e9a">mqtt</a>, &amp;mqtt_message)) {</div>
<div class="line">            <a class="code" href="group__Log.html#ga5d9529e9746395acc2cd96a28ffa1c28">SOL_WRN</a>(<span class="stringliteral">&quot;Unable to publish message&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">error:</div>
<div class="line">    <a class="code" href="group__Log.html#ga5d9529e9746395acc2cd96a28ffa1c28">SOL_WRN</a>(<span class="stringliteral">&quot;Could not read channel buffer values&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line"><a name="a60"></a><a class="code" href="iotivity-test-client_8c.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="group__IIO.html#gac894b251e6ef8abcfeb9f6134870fcff">sol_iio_device</a> *device = NULL;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a61"></a><a class="code" href="structsol__iio__config.html">sol_iio_config</a> iio_config = {};</div>
<div class="line">    <span class="keyword">struct </span><a name="_a62"></a><a class="code" href="structsol__iio__channel__config.html">sol_iio_channel_config</a> channel_config = <a name="a63"></a><a class="code" href="group__IIO.html#ga745de759f8289b9587f2bccd07634b30">SOL_IIO_CHANNEL_CONFIG_INIT</a>;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structiio__gyroscope__data.html">iio_gyroscope_data</a> gyro_data = {};</div>
<div class="line">    <span class="keyword">struct </span><a name="_a64"></a><a class="code" href="structsol__mqtt__config.html">sol_mqtt_config</a> mqtt_config = {</div>
<div class="line">        <a class="code" href="group__Mainloop.html#ga794a88f51470a85bb21279b32cc570ca">SOL_SET_API_VERSION</a>(.<a name="a65"></a><a class="code" href="structsol__mqtt__config.html#ae877d0bc68e3b420c20ddc7f478c616a">api_version</a> = <a name="a66"></a><a class="code" href="sol-mqtt_8h.html#a7647fcd3db08da5783e6f7cd533b291d">SOL_MQTT_CONFIG_API_VERSION</a>, )</div>
<div class="line">        .clean_session = <span class="keyword">true</span>,</div>
<div class="line">        .keep_alive = 60,</div>
<div class="line">        .handlers = {</div>
<div class="line">            <a class="code" href="group__Mainloop.html#ga794a88f51470a85bb21279b32cc570ca">SOL_SET_API_VERSION</a>(.<a class="code" href="structsol__mqtt__config.html#ae877d0bc68e3b420c20ddc7f478c616a">api_version</a> = <a name="a67"></a><a class="code" href="sol-mqtt_8h.html#a112b3a0725ba0481fd7fcb0b18e22c7b">SOL_MQTT_HANDLERS_API_VERSION</a>, )</div>
<div class="line">            .connect = <a class="code" href="browse_8c.html#a896853ca3a8646c8a157243b09b03db5">on_connect</a>,</div>
<div class="line">            .disconnect = <a class="code" href="browse_8c.html#a4f1ee1d8963297187f5b28ae83940600">on_disconnect</a>,</div>
<div class="line">        },</div>
<div class="line">    };</div>
<div class="line">    <span class="keywordtype">int</span> device_id;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (argc &lt; 11) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;\nUsage: %s &lt;device name&gt; &lt;trigger name&gt; &lt;buffer size&gt; &quot;</span> \</div>
<div class="line">            <span class="stringliteral">&quot;&lt;sampling frequency&gt; &lt;scale&gt; &lt;custom offset&gt; &lt;offset&gt; &quot;</span> \</div>
<div class="line">            <span class="stringliteral">&quot;&lt;MQTT broker ip&gt; &lt;MQTT broker port&gt; &lt;MQTT topic&gt;\n&quot;</span> \</div>
<div class="line">            <span class="stringliteral">&quot;\t&lt;buffer size&gt;:\t\t0=default\n&quot;</span> \</div>
<div class="line">            <span class="stringliteral">&quot;\t&lt;sampling frequency&gt;:\t-1=default\n&quot;</span> \</div>
<div class="line">            <span class="stringliteral">&quot;\t&lt;scale&gt;:\t\t&lt;-1=default\n&quot;</span> \</div>
<div class="line">            <span class="stringliteral">&quot;\t&lt;custom offset&gt;:\ty or n\n&quot;</span> \</div>
<div class="line">            <span class="stringliteral">&quot;\t&lt;offset&gt;:\t\tonly take effect if custom offset is \&quot;y\&quot;\n&quot;</span> \</div>
<div class="line">            <span class="stringliteral">&quot;Press CTRL + C to quit\n&quot;</span> \</div>
<div class="line">            , argv[0]);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a name="a68"></a><a class="code" href="group__Mainloop.html#ga2b7881c0cfcf1516e99a57949987425c">sol_init</a>();</div>
<div class="line"></div>
<div class="line">    device_id = <a name="a69"></a><a class="code" href="group__IIO.html#gaf360d49744185e5907a06f2025aeeea2">sol_iio_address_device</a>(argv[1]);</div>
<div class="line">    <a class="code" href="group__Log.html#ga6b76857beab196e724ba7486e411617b">SOL_INT_CHECK_GOTO</a>(device_id, &lt; 0, error_iio);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group__Mainloop.html#ga794a88f51470a85bb21279b32cc570ca">SOL_SET_API_VERSION</a>(iio_config.<a name="a70"></a><a class="code" href="structsol__iio__config.html#a6502af0cb99ca9b1069627c16f4f454d">api_version</a> = <a name="a71"></a><a class="code" href="sol-iio_8h.html#a2cc6ac6a3a76087d099d949804018a59">SOL_IIO_CONFIG_API_VERSION</a>; )</div>
<div class="line">    iio_config.trigger_name = strdup(argv[2]);</div>
<div class="line">    <a name="a72"></a><a class="code" href="group__Log.html#ga54e82836a0158b537774689043b0fb75">SOL_NULL_CHECK_GOTO</a>(iio_config.trigger_name, error_iio);</div>
<div class="line"></div>
<div class="line">    iio_config.buffer_size = atoi(argv[3]);</div>
<div class="line">    iio_config.sampling_frequency = atoi(argv[4]);</div>
<div class="line">    channel_config.scale = atof(argv[5]);</div>
<div class="line">    if (strncmp(argv[6], &quot;y&quot;, 1) == 0) {</div>
<div class="line">        channel_config.<a name="a73"></a><a class="code" href="structsol__iio__channel__config.html#a0936e9071b3002faf321ca6d14142eda">use_custom_offset</a> = <span class="keyword">true</span>;</div>
<div class="line">        channel_config.<a name="a74"></a><a class="code" href="structsol__iio__channel__config.html#abfbb787e2983fce168aae83b2da9816d">offset</a> = atoi(argv[7]);</div>
<div class="line">    } <span class="keywordflow">else</span></div>
<div class="line">        channel_config.<a class="code" href="structsol__iio__channel__config.html#a0936e9071b3002faf321ca6d14142eda">use_custom_offset</a> = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">    iio_config.<a name="a75"></a><a class="code" href="structsol__iio__config.html#af00647cfa357e7fb1b72e22b8c06936b">data</a> = &amp;gyro_data;</div>
<div class="line">    iio_config.<a name="a76"></a><a class="code" href="structsol__iio__config.html#a2baeffc79f9145cf891097b72ee7585e">sol_iio_reader_cb</a> = <a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a4f29673b4a00b8c6740301f425f4eb81">iio_gyroscope_reader_cb</a>;</div>
<div class="line"></div>
<div class="line">    mqtt_config.<a name="a77"></a><a class="code" href="structsol__mqtt__config.html#a14bfdcf781fcc4ae911dd499257c4cae">host</a> = argv[8];</div>
<div class="line">    mqtt_config.<a name="a78"></a><a class="code" href="structsol__mqtt__config.html#aaf03d8f6c3d8ae136f993569b8feca87">port</a> = atoi(argv[9]);</div>
<div class="line">    gyro_data.<a class="code" href="structiio__gyroscope__data.html#abf9faca15bb614f832d7738614c8e58d">mqtt_topic</a> = argv[10];</div>
<div class="line"></div>
<div class="line">    device = <a name="a79"></a><a class="code" href="group__IIO.html#ga68b2b55ed05f8165a957d62b99077352">sol_iio_open</a>(device_id, &amp;iio_config);</div>
<div class="line">    <a class="code" href="group__Log.html#ga54e82836a0158b537774689043b0fb75">SOL_NULL_CHECK_GOTO</a>(device, error_iio);</div>
<div class="line"></div>
<div class="line">    gyro_data.<a class="code" href="structiio__gyroscope__data.html#a79ae89202d5868dda5b80addf301b7c8">channel_x</a> = <a name="a80"></a><a class="code" href="group__IIO.html#ga84d03817d5512039aeeb417008eaff28">sol_iio_add_channel</a>(device, <span class="stringliteral">&quot;in_anglvel_x&quot;</span>,</div>
<div class="line">        &amp;channel_config);</div>
<div class="line">    <a class="code" href="group__Log.html#ga54e82836a0158b537774689043b0fb75">SOL_NULL_CHECK_GOTO</a>(gyro_data.<a class="code" href="structiio__gyroscope__data.html#a79ae89202d5868dda5b80addf301b7c8">channel_x</a>, error_iio);</div>
<div class="line"></div>
<div class="line">    gyro_data.<a class="code" href="structiio__gyroscope__data.html#a5ed8c9d3cd196905fa241b065685314f">channel_y</a> = <a class="code" href="group__IIO.html#ga84d03817d5512039aeeb417008eaff28">sol_iio_add_channel</a>(device, <span class="stringliteral">&quot;in_anglvel_y&quot;</span>,</div>
<div class="line">        &amp;channel_config);</div>
<div class="line">    <a class="code" href="group__Log.html#ga54e82836a0158b537774689043b0fb75">SOL_NULL_CHECK_GOTO</a>(gyro_data.<a class="code" href="structiio__gyroscope__data.html#a5ed8c9d3cd196905fa241b065685314f">channel_y</a>, error_iio);</div>
<div class="line"></div>
<div class="line">    gyro_data.<a class="code" href="structiio__gyroscope__data.html#a78bfda207c4021b308202d0879663391">channel_z</a> = <a class="code" href="group__IIO.html#ga84d03817d5512039aeeb417008eaff28">sol_iio_add_channel</a>(device, <span class="stringliteral">&quot;in_anglvel_z&quot;</span>,</div>
<div class="line">        &amp;channel_config);</div>
<div class="line">    <a class="code" href="group__Log.html#ga54e82836a0158b537774689043b0fb75">SOL_NULL_CHECK_GOTO</a>(gyro_data.<a class="code" href="structiio__gyroscope__data.html#a78bfda207c4021b308202d0879663391">channel_z</a>, error_iio);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef GYRO_CALIBRATE</span></div>
<div class="line"><span class="preprocessor"></span>    <a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a39b32d4b07905139afb451c9e2e85832">reset_calibrate</a>(&amp;(gyro_data.<a class="code" href="structiio__gyroscope__data.html#a77db7e634c9b4bd3d4071d703553038c">cal_data</a>));</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    gyro_data.<a class="code" href="structiio__gyroscope__data.html#a23d16effb5e75a9ccd49120576b3e555">drop_samples_count</a> = 0;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef DENOISE_MEDIAN</span></div>
<div class="line"><span class="preprocessor"></span>    gyro_data.<a class="code" href="structiio__gyroscope__data.html#a958244f564c12cd54a169f485bb9bc80">filter_data</a>.<a class="code" href="structfilter__median.html#a1fbf976fcf54b6d6865e60f143518cf4">buff</a> = (<span class="keywordtype">double</span> *)calloc(<a name="a81"></a><a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a4d74fafc2c907dd805eec278cd51ce7e">GYRO_DENOISE_MAX_SAMPLES</a>,</div>
<div class="line">        <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * <a name="a82"></a><a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#ab14b85dfc8fa6dbc5b6f86a34a810bde">GYRO_DENOISE_NUM_FIELDS</a>);</div>
<div class="line">    <a class="code" href="group__Log.html#ga54e82836a0158b537774689043b0fb75">SOL_NULL_CHECK_GOTO</a>(gyro_data.<a class="code" href="structiio__gyroscope__data.html#a958244f564c12cd54a169f485bb9bc80">filter_data</a>.<a class="code" href="structfilter__median.html#a1fbf976fcf54b6d6865e60f143518cf4">buff</a>, error_iio);</div>
<div class="line"></div>
<div class="line">    gyro_data.<a class="code" href="structiio__gyroscope__data.html#a958244f564c12cd54a169f485bb9bc80">filter_data</a>.<a class="code" href="structfilter__median.html#a2bceb8907818e0f9d7dbd7d89d42cb9e">sample_size</a> = <a class="code" href="iio-gyroscope-console-and-mqtt-publish_8c.html#a4d74fafc2c907dd805eec278cd51ce7e">GYRO_DENOISE_MAX_SAMPLES</a>;</div>
<div class="line">    gyro_data.<a class="code" href="structiio__gyroscope__data.html#a958244f564c12cd54a169f485bb9bc80">filter_data</a>.<a class="code" href="structfilter__median.html#a236441a297e05e216f6746df1e5cecd3">count</a> = 0;</div>
<div class="line">    gyro_data.<a class="code" href="structiio__gyroscope__data.html#a958244f564c12cd54a169f485bb9bc80">filter_data</a>.<a class="code" href="structfilter__median.html#a223412541ddb04ff040bb7e53d44e777">idx</a> = 0;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <a name="a83"></a><a class="code" href="group__IIO.html#ga0008cf399431dc938ad9c79223136127">sol_iio_device_start_buffer</a>(device);</div>
<div class="line"></div>
<div class="line">    gyro_data.<a class="code" href="structiio__gyroscope__data.html#a4f719ca3f4feb3f5f1c81f3bb6d46e9a">mqtt</a> = <a name="a84"></a><a class="code" href="group__MQTT.html#ga08ee4834e38274179d3e5a5fc9bcb234">sol_mqtt_connect</a>(&amp;mqtt_config);</div>
<div class="line">    <a class="code" href="group__Log.html#ga54e82836a0158b537774689043b0fb75">SOL_NULL_CHECK_GOTO</a>(gyro_data.<a class="code" href="structiio__gyroscope__data.html#a4f719ca3f4feb3f5f1c81f3bb6d46e9a">mqtt</a>, error_iio);</div>
<div class="line"></div>
<div class="line">    <a name="a85"></a><a class="code" href="group__Mainloop.html#ga40ef0e2ee61ea7a548c00bbae980408b">sol_run</a>();</div>
<div class="line"></div>
<div class="line">    free((<span class="keywordtype">char</span> *)iio_config.<a name="a86"></a><a class="code" href="structsol__iio__config.html#a67ca853174abf013ea2f0513606ca34a">trigger_name</a>);</div>
<div class="line">    iio_config.<a class="code" href="structsol__iio__config.html#a67ca853174abf013ea2f0513606ca34a">trigger_name</a> = NULL;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef DENOISE_MEDIAN</span></div>
<div class="line"><span class="preprocessor"></span>    free(gyro_data.<a class="code" href="structiio__gyroscope__data.html#a958244f564c12cd54a169f485bb9bc80">filter_data</a>.<a class="code" href="structfilter__median.html#a1fbf976fcf54b6d6865e60f143518cf4">buff</a>);</div>
<div class="line">    gyro_data.<a class="code" href="structiio__gyroscope__data.html#a958244f564c12cd54a169f485bb9bc80">filter_data</a>.<a class="code" href="structfilter__median.html#a1fbf976fcf54b6d6865e60f143518cf4">buff</a> = NULL;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <span class="comment">/* Must do sol_iio_close(device), it will disable IIO buffer.</span></div>
<div class="line"><span class="comment">     * If not, the trigger, buffer size and buffer enable cannot be set</span></div>
<div class="line"><span class="comment">     * on the next launch.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <a name="a87"></a><a class="code" href="group__IIO.html#ga7ae55864c5761480f315ed5a40795ee8">sol_iio_close</a>(device);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="browse_8c.html#ab3606a13f5d028aa43f82d8989b84980">timeout</a>)</div>
<div class="line">        <a name="a88"></a><a class="code" href="group__Mainloop.html#gae1f45ba3de62603e90903d1214cf834f">sol_timeout_del</a>(<a class="code" href="browse_8c.html#ab3606a13f5d028aa43f82d8989b84980">timeout</a>);</div>
<div class="line"></div>
<div class="line">    <a name="a89"></a><a class="code" href="group__MQTT.html#gab8559f8615017d3fb418bd85d777fbb9">sol_mqtt_disconnect</a>(gyro_data.<a class="code" href="structiio__gyroscope__data.html#a4f719ca3f4feb3f5f1c81f3bb6d46e9a">mqtt</a>);</div>
<div class="line"></div>
<div class="line">    <a name="a90"></a><a class="code" href="group__Mainloop.html#gaf9fa52b0c849ded3ede3823eb1a90f76">sol_shutdown</a>();</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">error_iio:</div>
<div class="line">    <span class="keywordflow">if</span> (device) {</div>
<div class="line">        <span class="comment">/* Must do sol_iio_close(device), it will disable IIO buffer.</span></div>
<div class="line"><span class="comment">         * If not, the trigger, buffer size and buffer enable cannot be set</span></div>
<div class="line"><span class="comment">         * on the next launch.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <a class="code" href="group__IIO.html#ga7ae55864c5761480f315ed5a40795ee8">sol_iio_close</a>(device);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="browse_8c.html#ab3606a13f5d028aa43f82d8989b84980">timeout</a>)</div>
<div class="line">        <a class="code" href="group__Mainloop.html#gae1f45ba3de62603e90903d1214cf834f">sol_timeout_del</a>(<a class="code" href="browse_8c.html#ab3606a13f5d028aa43f82d8989b84980">timeout</a>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (iio_config.<a class="code" href="structsol__iio__config.html#a67ca853174abf013ea2f0513606ca34a">trigger_name</a>) {</div>
<div class="line">        free((<span class="keywordtype">char</span> *)iio_config.<a class="code" href="structsol__iio__config.html#a67ca853174abf013ea2f0513606ca34a">trigger_name</a>);</div>
<div class="line">        iio_config.<a class="code" href="structsol__iio__config.html#a67ca853174abf013ea2f0513606ca34a">trigger_name</a> = NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef DENOISE_MEDIAN</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">if</span> (gyro_data.<a class="code" href="structiio__gyroscope__data.html#a958244f564c12cd54a169f485bb9bc80">filter_data</a>.<a class="code" href="structfilter__median.html#a1fbf976fcf54b6d6865e60f143518cf4">buff</a>) {</div>
<div class="line">        free(gyro_data.<a class="code" href="structiio__gyroscope__data.html#a958244f564c12cd54a169f485bb9bc80">filter_data</a>.<a class="code" href="structfilter__median.html#a1fbf976fcf54b6d6865e60f143518cf4">buff</a>);</div>
<div class="line">        gyro_data.<a class="code" href="structiio__gyroscope__data.html#a958244f564c12cd54a169f485bb9bc80">filter_data</a>.<a class="code" href="structfilter__median.html#a1fbf976fcf54b6d6865e60f143518cf4">buff</a> = NULL;</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <a class="code" href="group__Mainloop.html#gaf9fa52b0c849ded3ede3823eb1a90f76">sol_shutdown</a>();</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- HTML footer for doxygen 1.8.9.1-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
<a href="http://solettaproject.github.io/docs/">Full online documentation</a> | 
<a href="index.html">C API Index</a>
</small></address>
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
