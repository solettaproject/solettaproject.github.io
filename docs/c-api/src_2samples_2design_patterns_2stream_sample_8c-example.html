<!-- HTML header for doxygen 1.8.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Soletta™ Framework: /src/samples/design_patterns/stream_sample.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Soletta™ Framework
   </div>
   <div id="projectbrief">
   Framework for making IoT devices<br /><br />
   <small>
   <a href="http://solettaproject.github.io/docs/">Full online documentation</a> | 
   <a href="index.html">C API Index</a>
   </small><br />
   </div>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">/src/samples/design_patterns/stream_sample.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This file is part of the Soletta (TM) Project</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2015 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></div>
<div class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></div>
<div class="line"><span class="comment"> * You may obtain a copy of the License at</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     http://www.apache.org/licenses/LICENSE-2.0</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></div>
<div class="line"><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></div>
<div class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></div>
<div class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></div>
<div class="line"><span class="comment"> * limitations under the License.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sol-log_8h.html">sol-log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sol-mainloop_8h.html">sol-mainloop.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sol-types_8h.html">sol-types.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sol-buffer_8h.html">sol-buffer.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sol-util_8h.html">sol-util.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sol-reentrant_8h.html">sol-reentrant.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="soletta_8h.html">soletta.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define my_stream_device_write write</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define my_stream_device_read read</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define my_stream_device_add_io_monitor sol_fd_add</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define my_stream_device_remove_io_monitor sol_fd_del</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define my_stream_device_monitor_handle struct sol_fd</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span><a name="_a1"></a><a class="code" href="structmy__stream__api__config.html">my_stream_api_config</a> {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">void</span> *<a name="a2"></a><a class="code" href="structmy__stream__api__config.html#a305b6d602ae19a82c20d2228d8c3eba9">user_data</a>;</div>
<div class="line">    void (*<a name="a3"></a><a class="code" href="structmy__stream__api__config.html#a309cd33a61e1661a78afed9339b23b6d">on_feed_done</a>)(<span class="keywordtype">void</span> *<a class="code" href="structmy__stream__api__config.html#a305b6d602ae19a82c20d2228d8c3eba9">user_data</a>, <span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle, <span class="keyword">struct </span><a name="_a4"></a><a class="code" href="structsol__blob.html">sol_blob</a> *blob, <span class="keywordtype">int</span> status);</div>
<div class="line">    ssize_t (*<a name="a5"></a><a class="code" href="structmy__stream__api__config.html#a0a29a85be0f186c3b1c6a366fcc49fd4">on_data</a>)(<span class="keywordtype">void</span> *<a class="code" href="structmy__stream__api__config.html#a305b6d602ae19a82c20d2228d8c3eba9">user_data</a>, <span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle, <span class="keyword">const</span> <span class="keyword">struct </span><a name="_a6"></a><a class="code" href="structsol__buffer.html">sol_buffer</a> *buf);</div>
<div class="line">    <span class="keywordtype">size_t</span> <a name="a7"></a><a class="code" href="structmy__stream__api__config.html#ae6ab80cb4784977da1c86cee04b5cb71">feed_size</a>;</div>
<div class="line">    <span class="keywordtype">size_t</span> <a name="a8"></a><a class="code" href="structmy__stream__api__config.html#aa5f21fc73373f77c21d91004bea31dd3">data_buffer_size</a>;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *<a name="a9"></a><a class="code" href="stream__sample_8c.html#a3998878d95b5e5642e93b9e764160095">my_stream_api_new</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmy__stream__api__config.html">my_stream_api_config</a> *config, <span class="keywordtype">int</span> <a name="a10"></a><a class="code" href="structmy__stream__api__handle.html#af9f3eba48475670675524341901fde7d">dev</a>);</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">void</span> *<a name="a11"></a><a class="code" href="structmy__stream__api__handle.html#a5b71a6ec147c6c8d4784f254c5441bcf">user_data</a>;</div>
<div class="line">    void (*<a name="a12"></a><a class="code" href="structmy__stream__api__handle.html#a0b20babd45d1ef5d8ec42e3d54f14f89">on_feed_done</a>)(<span class="keywordtype">void</span> *<a class="code" href="structmy__stream__api__handle.html#a5b71a6ec147c6c8d4784f254c5441bcf">user_data</a>, <span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle, <span class="keyword">struct </span><a class="code" href="structsol__blob.html">sol_blob</a> *blob, <span class="keywordtype">int</span> status);</div>
<div class="line">    ssize_t (*<a name="a13"></a><a class="code" href="structmy__stream__api__handle.html#aef373a1c0e8d436eda86d26598c33e7b">on_data</a>)(<span class="keywordtype">void</span> *<a class="code" href="structmy__stream__api__handle.html#a5b71a6ec147c6c8d4784f254c5441bcf">user_data</a>, <span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle, <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structsol__buffer.html">sol_buffer</a> *buf);</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="group__Mainloop.html#ga40dddc147a0d6370aeb8219a90b56596">sol_timeout</a> *<a name="a14"></a><a class="code" href="structmy__stream__api__handle.html#abf5df3c3e80848524bcc63193da0469c">read_timeout</a>;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structsol__buffer.html">sol_buffer</a> <a name="a15"></a><a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a16"></a><a class="code" href="structsol__ptr__vector.html">sol_ptr_vector</a> <a name="a17"></a><a class="code" href="structmy__stream__api__handle.html#a67ae8e9c83e8309a3da87c5df739558a">pending_blobs</a>;</div>
<div class="line">    <a name="a18"></a><a class="code" href="stream__sample_8c.html#a84ef4c43fe6ed66f0a11d5c9e473070e">my_stream_device_monitor_handle</a> *<a name="a19"></a><a class="code" href="structmy__stream__api__handle.html#a3c24f022235965c0d0463c6205d5e63e">read_monitor</a>;</div>
<div class="line">    <a class="code" href="stream__sample_8c.html#a84ef4c43fe6ed66f0a11d5c9e473070e">my_stream_device_monitor_handle</a> *<a name="a20"></a><a class="code" href="structmy__stream__api__handle.html#a6730010206b507c04b52945c7a726248">write_monitor</a>;</div>
<div class="line">    <span class="keywordtype">size_t</span> <a name="a21"></a><a class="code" href="structmy__stream__api__handle.html#ab6cc8c06107f968fd5af69d3a9dfe0b6">feed_size</a>;</div>
<div class="line">    <span class="keywordtype">size_t</span> <a name="a22"></a><a class="code" href="structmy__stream__api__handle.html#a0eb24dfcdd091f843f534f6f79f83325">pending_bytes</a>;</div>
<div class="line">    <span class="keywordtype">size_t</span> <a name="a23"></a><a class="code" href="structmy__stream__api__handle.html#aea5e303a5ce8020904a03363e329f8f2">written</a>;</div>
<div class="line">    <span class="keywordtype">int</span> <a class="code" href="structmy__stream__api__handle.html#af9f3eba48475670675524341901fde7d">dev</a>;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a24"></a><a class="code" href="structsol__reentrant.html">sol_reentrant</a> <a name="a25"></a><a class="code" href="structmy__stream__api__handle.html#abe5c53a9b38f4b6c1d2d6f6105a4d78c">reentrant</a>;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a name="a26"></a><a class="code" href="stream__sample_8c.html#ac0e72426d06273925e202bfef56a127d">api_close</a>(<span class="keyword">struct</span> <a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define DEFAULT_BUFFER_SIZE (4096)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keywordtype">int</span> <a name="a27"></a><a class="code" href="stream__sample_8c.html#a639e091ebfcde41608de7db1e247c9f6">my_stream_api_feed</a>(<span class="keyword">struct</span> <a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle, <span class="keyword">struct</span> <a class="code" href="structsol__blob.html">sol_blob</a> *blob);</div>
<div class="line"><span class="keywordtype">void</span> <a name="a28"></a><a class="code" href="stream__sample_8c.html#a86de373ce01d0d7b8bee9b849e80881b">my_stream_api_close</a>(<span class="keyword">struct</span> <a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//The write operation itself</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span></div>
<div class="line"><a name="a29"></a><a class="code" href="stream__sample_8c.html#a59c664cac2d659cbe290e218c870318f">_can_write</a>(<span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> <a name="a30"></a><a class="code" href="download_8c.html#a600b792d6d2ff2e71096dfa60d97a3b0">fd</a>, uint32_t active_flags)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle = data;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structsol__blob.html">sol_blob</a> *blob;</div>
<div class="line">    ssize_t status;</div>
<div class="line">    <span class="keywordtype">bool</span> r = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Write the blob</span></div>
<div class="line">    blob = <a name="a31"></a><a class="code" href="group__PointerVector.html#gae21a26f15b2b3d2dd818dba89f42b4f3">sol_ptr_vector_get</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a67ae8e9c83e8309a3da87c5df739558a">pending_blobs</a>, 0);</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Write into the stream</span></div>
<div class="line">    status = <a name="a32"></a><a class="code" href="stream__sample_8c.html#a310d6b8f1ff08b8d06b49680d936fce7">my_stream_device_write</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#af9f3eba48475670675524341901fde7d">dev</a>, (<span class="keywordtype">char</span> *)blob-&gt;<a name="a33"></a><a class="code" href="structsol__blob.html#a902b9909ebabd0cc784ce0d9f64c6940">mem</a> + handle-&gt;<a class="code" href="structmy__stream__api__handle.html#aea5e303a5ce8020904a03363e329f8f2">written</a>, blob-&gt;<a name="a34"></a><a class="code" href="structsol__blob.html#aa708cb5e0186b24dc4eee1a4669577b7">size</a>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (status &lt; 0) {</div>
<div class="line">        <span class="keywordflow">if</span> (status == EAGAIN || status == EINTR)</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">        <span class="keywordflow">else</span> {</div>
<div class="line">            <a name="a35"></a><a class="code" href="group__Log.html#ga5d9529e9746395acc2cd96a28ffa1c28">SOL_WRN</a>(<span class="stringliteral">&quot;Could not write to the stream device!&quot;</span>);</div>
<div class="line">            handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a6730010206b507c04b52945c7a726248">write_monitor</a> = NULL;</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Update how many bytes have been written</span></div>
<div class="line">    handle-&gt;<a class="code" href="structmy__stream__api__handle.html#aea5e303a5ce8020904a03363e329f8f2">written</a> += status;</div>
<div class="line">    handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a0eb24dfcdd091f843f534f6f79f83325">pending_bytes</a> -= status;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Blob was completly written. Inform the user.</span></div>
<div class="line">    <span class="keywordflow">if</span> (handle-&gt;<a class="code" href="structmy__stream__api__handle.html#aea5e303a5ce8020904a03363e329f8f2">written</a> == blob-&gt;<a class="code" href="structsol__blob.html#aa708cb5e0186b24dc4eee1a4669577b7">size</a>) {</div>
<div class="line">        <span class="comment">//Do we still have more data ?</span></div>
<div class="line">        <a name="a36"></a><a class="code" href="group__PointerVector.html#gabf7e6eee8dc6d91c9ba1c07f13eb7f81">sol_ptr_vector_del</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a67ae8e9c83e8309a3da87c5df739558a">pending_blobs</a>, 0);</div>
<div class="line">        <span class="keywordflow">if</span> (!<a name="a37"></a><a class="code" href="group__PointerVector.html#ga979ef2866af8cc57b616f125c0a16ea7">sol_ptr_vector_get_len</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a67ae8e9c83e8309a3da87c5df739558a">pending_blobs</a>)) {</div>
<div class="line">            r = <span class="keyword">false</span>;</div>
<div class="line">            handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a6730010206b507c04b52945c7a726248">write_monitor</a> = NULL;</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">//Reset the written counter</span></div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#aea5e303a5ce8020904a03363e329f8f2">written</a> = 0;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">           Inform the user.</span></div>
<div class="line"><span class="comment">           Since it&#39;s completly safe to call my_stream_api_close() inside on_feed_done().</span></div>
<div class="line"><span class="comment">           Informing the user should be the last thing to do.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">if</span> (handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a0b20babd45d1ef5d8ec42e3d54f14f89">on_feed_done</a>)</div>
<div class="line">            handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a0b20babd45d1ef5d8ec42e3d54f14f89">on_feed_done</a>((<span class="keywordtype">void</span> *)handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a5b71a6ec147c6c8d4784f254c5441bcf">user_data</a>, handle, blob, status);</div>
<div class="line">        <a name="a38"></a><a class="code" href="group__Types.html#gaaf14a0023ae6a06a7e9960e5b622a2ad">sol_blob_unref</a>(blob); <span class="comment">//NOTE: that we unref the blob, not the user!</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> r;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line"><a class="code" href="stream__sample_8c.html#a639e091ebfcde41608de7db1e247c9f6">my_stream_api_feed</a>(<span class="keyword">struct</span> <a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle, <span class="keyword">struct</span> <a class="code" href="structsol__blob.html">sol_blob</a> *blob)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">size_t</span> total;</div>
<div class="line">    <span class="keywordtype">int</span> r;</div>
<div class="line"></div>
<div class="line">    <a name="a39"></a><a class="code" href="group__Log.html#gacb48844cf78438b772f069c089836835">SOL_NULL_CHECK</a>(handle, -EINVAL);</div>
<div class="line">    <a class="code" href="group__Log.html#gacb48844cf78438b772f069c089836835">SOL_NULL_CHECK</a>(blob, -EINVAL);</div>
<div class="line">    <span class="comment">//Do not try to write with the uart is going to be closed</span></div>
<div class="line">    <a name="a40"></a><a class="code" href="group__Log.html#ga7ceb60c9648222c6d1fa660ec9fc1fe6">SOL_EXP_CHECK</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abe5c53a9b38f4b6c1d2d6f6105a4d78c">reentrant</a>.<a name="a41"></a><a class="code" href="structsol__reentrant.html#a3b0f6f7122f0a296a1f8d5628072c6bc">delete_me</a>, -EINVAL);</div>
<div class="line"></div>
<div class="line">    total = handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a0eb24dfcdd091f843f534f6f79f83325">pending_bytes</a> + blob-&gt;<a class="code" href="structsol__blob.html#aa708cb5e0186b24dc4eee1a4669577b7">size</a>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//feed_size was set and the total must not exceed feed_size</span></div>
<div class="line">    <span class="keywordflow">if</span> (handle-&gt;<a class="code" href="structmy__stream__api__handle.html#ab6cc8c06107f968fd5af69d3a9dfe0b6">feed_size</a> &amp;&amp; total &gt;= handle-&gt;<a class="code" href="structmy__stream__api__handle.html#ab6cc8c06107f968fd5af69d3a9dfe0b6">feed_size</a>)</div>
<div class="line">        <span class="keywordflow">return</span> -ENOSPC; <span class="comment">//Try again later</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">//Store the blob and ref it, since it will written later.</span></div>
<div class="line">    r = <a name="a42"></a><a class="code" href="group__PointerVector.html#gab48f4a05d4101d836375dcf7106aaa00">sol_ptr_vector_append</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a67ae8e9c83e8309a3da87c5df739558a">pending_blobs</a>, blob);</div>
<div class="line">    <a name="a43"></a><a class="code" href="group__Log.html#ga8b7a2ba17c9bf66ad98238f0ca591413">SOL_INT_CHECK</a>(r, &lt; 0, r);</div>
<div class="line">    <a name="a44"></a><a class="code" href="group__Types.html#ga4037a7e2e24c7f74c92bea431035776d">sol_blob_ref</a>(blob);</div>
<div class="line">    handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a0eb24dfcdd091f843f534f6f79f83325">pending_bytes</a> = total;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Schedule the write operation</span></div>
<div class="line">    <span class="keywordflow">if</span> (!handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a6730010206b507c04b52945c7a726248">write_monitor</a>) {</div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a6730010206b507c04b52945c7a726248">write_monitor</a> = <a name="a45"></a><a class="code" href="stream__sample_8c.html#a5ced3281145daa31ecbf232f4ea7b84a">my_stream_device_add_io_monitor</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#af9f3eba48475670675524341901fde7d">dev</a>,</div>
<div class="line">            SOL_FD_FLAGS_OUT, <a class="code" href="stream__sample_8c.html#a59c664cac2d659cbe290e218c870318f">_can_write</a>, handle);</div>
<div class="line">        <a name="a46"></a><a class="code" href="group__Log.html#ga54e82836a0158b537774689043b0fb75">SOL_NULL_CHECK_GOTO</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a6730010206b507c04b52945c7a726248">write_monitor</a>, err_monitor);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">err_monitor:</div>
<div class="line">    <a name="a47"></a><a class="code" href="group__PointerVector.html#gafd8d8290ff6aef284c8aa6a664088826">sol_ptr_vector_del_element</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a67ae8e9c83e8309a3da87c5df739558a">pending_blobs</a>, blob);</div>
<div class="line">    <a class="code" href="group__Types.html#gaaf14a0023ae6a06a7e9960e5b622a2ad">sol_blob_unref</a>(blob);</div>
<div class="line">    <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//Delivery the data to the user</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span></div>
<div class="line"><a name="a48"></a><a class="code" href="stream__sample_8c.html#a2f9f4d9b9c23b6a058b614a3f8a18dd9">_inform_user</a>(<span class="keywordtype">void</span> *data)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle = data;</div>
<div class="line">    ssize_t r;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Flag that the handle is in use</span></div>
<div class="line">    <a name="a49"></a><a class="code" href="group__Reentrant.html#ga9ea2042382ce22b3f8bc086bc211e792">SOL_REENTRANT_CALL</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abe5c53a9b38f4b6c1d2d6f6105a4d78c">reentrant</a>) {</div>
<div class="line">        <span class="comment">//Inform the user</span></div>
<div class="line">        r = handle-&gt;<a class="code" href="structmy__stream__api__handle.html#aef373a1c0e8d436eda86d26598c33e7b">on_data</a>((<span class="keywordtype">void</span> *)handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a5b71a6ec147c6c8d4784f254c5441bcf">user_data</a>, handle, &amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Remove the data.</span></div>
<div class="line">    <span class="keywordflow">if</span> (r &lt; 0)</div>
<div class="line">        <a name="a50"></a><a class="code" href="group__Log.html#ga823cf64eb1674aa6f3337e05563d5929">SOL_ERR</a>(<span class="stringliteral">&quot;Something wrong happened %zd&quot;</span>, r);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <a name="a51"></a><a class="code" href="group__Buffer.html#ga4c5ac235da1f72ad8866570723eeb8a3">sol_buffer_remove_data</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>, 0, r);</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Close the handle</span></div>
<div class="line">    <span class="keywordflow">if</span> (handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abe5c53a9b38f4b6c1d2d6f6105a4d78c">reentrant</a>.<a class="code" href="structsol__reentrant.html#a3b0f6f7122f0a296a1f8d5628072c6bc">delete_me</a>) {</div>
<div class="line">        <a name="a52"></a><a class="code" href="group__Reentrant.html#ga6b0fac049a35897fc6d6551fb72e3eb7">SOL_REENTRANT_FREE</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abe5c53a9b38f4b6c1d2d6f6105a4d78c">reentrant</a>) {</div>
<div class="line">            <a class="code" href="stream__sample_8c.html#ac0e72426d06273925e202bfef56a127d">api_close</a>(handle);</div>
<div class="line">        }</div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abf5df3c3e80848524bcc63193da0469c">read_timeout</a> = NULL;</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Still need to callback the user with remaining data, keep the timer running</span></div>
<div class="line">    <span class="keywordflow">if</span> (handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>.<a name="a53"></a><a class="code" href="structsol__buffer.html#a50844b0cbc4ae956fd4335537756bfa9">used</a>)</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abf5df3c3e80848524bcc63193da0469c">read_timeout</a> = NULL;</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//Actually read from the device</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span></div>
<div class="line"><a name="a54"></a><a class="code" href="stream__sample_8c.html#ab36534599cf0df085cd00606e29173f8">_can_read</a>(<span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> fd, uint32_t active_flags)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle = data;</div>
<div class="line">    <span class="keywordtype">size_t</span> remaining = handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>.<a name="a55"></a><a class="code" href="structsol__buffer.html#a5da3d12dd7be7f032c8f4ad4a7e5975b">capacity</a> - handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>.<a class="code" href="structsol__buffer.html#a50844b0cbc4ae956fd4335537756bfa9">used</a>;</div>
<div class="line">    ssize_t status;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//The rx buffer is full. Try to expand it in order to store more data.</span></div>
<div class="line">    <span class="keywordflow">if</span> (!remaining &amp;&amp; !(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>.<a name="a56"></a><a class="code" href="structsol__buffer.html#a1efd437e9b7844cc5d120b4204bd53cd">flags</a> &amp; <a name="a57"></a><a class="code" href="group__Buffer.html#ggaa7349ebf92ae19e234119719eb74e9beaedd472f65c286fd8b066d6e8ff2b1789">SOL_BUFFER_FLAGS_FIXED_CAPACITY</a>)) {</div>
<div class="line">        <span class="keywordtype">int</span> err;</div>
<div class="line"></div>
<div class="line">        err = <a name="a58"></a><a class="code" href="group__Buffer.html#ga6cfddb6d81fec1263637b02e441a0f64">sol_buffer_expand</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>, <a name="a59"></a><a class="code" href="stream__sample_8c.html#a6e576a3c6530636d68b7a220480bcd32">DEFAULT_BUFFER_SIZE</a>);</div>
<div class="line">        <a class="code" href="group__Log.html#ga8b7a2ba17c9bf66ad98238f0ca591413">SOL_INT_CHECK</a>(err, &lt; 0, <span class="keyword">true</span>);</div>
<div class="line">        remaining = <a class="code" href="stream__sample_8c.html#a6e576a3c6530636d68b7a220480bcd32">DEFAULT_BUFFER_SIZE</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (remaining &gt; 0) {</div>
<div class="line">        <span class="comment">//Append data to the buffer</span></div>
<div class="line">        status = <a name="a60"></a><a class="code" href="stream__sample_8c.html#a060d10833a9dab8f63d11aec7bc00bf1">my_stream_device_read</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#af9f3eba48475670675524341901fde7d">dev</a>, <a name="a61"></a><a class="code" href="group__Buffer.html#gae055658101d5ea00251be938e22f8b92">sol_buffer_at_end</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>), remaining);</div>
<div class="line">        <span class="keywordflow">if</span> (status &lt; 0) {</div>
<div class="line">            <span class="keywordflow">if</span> (status == EAGAIN || status == EINTR)</div>
<div class="line">                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">            <span class="keywordflow">else</span> {</div>
<div class="line">                <a class="code" href="group__Log.html#ga5d9529e9746395acc2cd96a28ffa1c28">SOL_WRN</a>(<span class="stringliteral">&quot;Could not read to the stream device!&quot;</span>);</div>
<div class="line">                handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a3c24f022235965c0d0463c6205d5e63e">read_monitor</a> = NULL;</div>
<div class="line">                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>.<a class="code" href="structsol__buffer.html#a50844b0cbc4ae956fd4335537756bfa9">used</a> += status;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abf5df3c3e80848524bcc63193da0469c">read_timeout</a>)</div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abf5df3c3e80848524bcc63193da0469c">read_timeout</a> = <a name="a62"></a><a class="code" href="group__Mainloop.html#ga9d0cd6af9dab4da3002e5cd596ce604f">sol_timeout_add</a>(0, <a class="code" href="stream__sample_8c.html#a2f9f4d9b9c23b6a058b614a3f8a18dd9">_inform_user</a>, handle);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//Stream creation, where on_data is configured</span></div>
<div class="line"><span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *</div>
<div class="line"><a class="code" href="stream__sample_8c.html#a3998878d95b5e5642e93b9e764160095">my_stream_api_new</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmy__stream__api__config.html">my_stream_api_config</a> *config, <span class="keywordtype">int</span> <a class="code" href="structmy__stream__api__handle.html#af9f3eba48475670675524341901fde7d">dev</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle;</div>
<div class="line">    <span class="keywordtype">size_t</span> data_buffer_size = 0;</div>
<div class="line">    <span class="keywordtype">void</span> *buf = NULL;</div>
<div class="line">    <span class="comment">//By default the rx buffer will not be limited</span></div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="group__Buffer.html#gaa7349ebf92ae19e234119719eb74e9be">sol_buffer_flags</a> flags = <a name="a63"></a><a class="code" href="group__Buffer.html#ggaa7349ebf92ae19e234119719eb74e9beafd1d0f37242c92450c0e596c17a80dc8">SOL_BUFFER_FLAGS_NO_NUL_BYTE</a> | <a name="a64"></a><a class="code" href="group__Buffer.html#ggaa7349ebf92ae19e234119719eb74e9bea2f0b03321abe3527160986cb213ab520">SOL_BUFFER_FLAGS_DEFAULT</a>;</div>
<div class="line"></div>
<div class="line">    handle = calloc(1, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a>));</div>
<div class="line">    <a class="code" href="group__Log.html#gacb48844cf78438b772f069c089836835">SOL_NULL_CHECK</a>(handle, NULL);</div>
<div class="line"></div>
<div class="line">    handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a0b20babd45d1ef5d8ec42e3d54f14f89">on_feed_done</a> = config-&gt;<a class="code" href="structmy__stream__api__config.html#a309cd33a61e1661a78afed9339b23b6d">on_feed_done</a>;</div>
<div class="line">    handle-&gt;<a class="code" href="structmy__stream__api__handle.html#ab6cc8c06107f968fd5af69d3a9dfe0b6">feed_size</a> = config-&gt;<a class="code" href="structmy__stream__api__config.html#ae6ab80cb4784977da1c86cee04b5cb71">feed_size</a>;</div>
<div class="line">    handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a5b71a6ec147c6c8d4784f254c5441bcf">user_data</a> = config-&gt;<a class="code" href="structmy__stream__api__config.html#a305b6d602ae19a82c20d2228d8c3eba9">user_data</a>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//The user does not want to read from the stream, ignore rx configuration.</span></div>
<div class="line">    <span class="keywordflow">if</span> (config-&gt;<a class="code" href="structmy__stream__api__config.html#a0a29a85be0f186c3b1c6a366fcc49fd4">on_data</a>) {</div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#aef373a1c0e8d436eda86d26598c33e7b">on_data</a> = config-&gt;<a class="code" href="structmy__stream__api__config.html#a0a29a85be0f186c3b1c6a366fcc49fd4">on_data</a>;</div>
<div class="line">        data_buffer_size = config-&gt;<a class="code" href="structmy__stream__api__config.html#aa5f21fc73373f77c21d91004bea31dd3">data_buffer_size</a>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">//The rx buffer has a fixed size and we should respect that.</span></div>
<div class="line">        <span class="keywordflow">if</span> (data_buffer_size) {</div>
<div class="line">            buf = malloc(data_buffer_size);</div>
<div class="line">            <a class="code" href="group__Log.html#ga54e82836a0158b537774689043b0fb75">SOL_NULL_CHECK_GOTO</a>(buf, err_buf);</div>
<div class="line">            flags |= <a class="code" href="group__Buffer.html#ggaa7349ebf92ae19e234119719eb74e9beaedd472f65c286fd8b066d6e8ff2b1789">SOL_BUFFER_FLAGS_FIXED_CAPACITY</a>;</div>
<div class="line">        } <span class="comment">//else - The user is informing that the rx buffer should be unlimited</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">//Setup input monitor</span></div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a3c24f022235965c0d0463c6205d5e63e">read_monitor</a> = <a class="code" href="stream__sample_8c.html#a5ced3281145daa31ecbf232f4ea7b84a">my_stream_device_add_io_monitor</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#af9f3eba48475670675524341901fde7d">dev</a>, SOL_FD_FLAGS_IN, <a class="code" href="stream__sample_8c.html#ab36534599cf0df085cd00606e29173f8">_can_read</a>, handle);</div>
<div class="line">        <a class="code" href="group__Log.html#ga54e82836a0158b537774689043b0fb75">SOL_NULL_CHECK_GOTO</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a3c24f022235965c0d0463c6205d5e63e">read_monitor</a>, err_monitor);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a name="a65"></a><a class="code" href="group__Buffer.html#ga4eadd7e2b51c49dc19fa52d37e8776ba">sol_buffer_init_flags</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>, buf, data_buffer_size, flags);</div>
<div class="line">    <a name="a66"></a><a class="code" href="group__PointerVector.html#gac398e94fafafaea31c54becda7b9b0c2">sol_ptr_vector_init</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a67ae8e9c83e8309a3da87c5df739558a">pending_blobs</a>);</div>
<div class="line">    handle-&gt;<a class="code" href="structmy__stream__api__handle.html#af9f3eba48475670675524341901fde7d">dev</a> = <a class="code" href="structmy__stream__api__handle.html#af9f3eba48475670675524341901fde7d">dev</a>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> handle;</div>
<div class="line"></div>
<div class="line">err_monitor:</div>
<div class="line">    free(buf);</div>
<div class="line">err_buf:</div>
<div class="line">    free(handle);</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a class="code" href="stream__sample_8c.html#ac0e72426d06273925e202bfef56a127d">api_close</a>(<span class="keyword">struct</span> <a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle)</div>
<div class="line">{</div>
<div class="line">    uint16_t i;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structsol__blob.html">sol_blob</a> *blob;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Inform that some blobs where not sent</span></div>
<div class="line">    <a name="a67"></a><a class="code" href="group__PointerVector.html#gaf63bd1dc979cddb3c39d998c218993ed">SOL_PTR_VECTOR_FOREACH_IDX</a> (&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a67ae8e9c83e8309a3da87c5df739558a">pending_blobs</a>, blob, i) {</div>
<div class="line">        <span class="keywordflow">if</span> (handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a0b20babd45d1ef5d8ec42e3d54f14f89">on_feed_done</a>)</div>
<div class="line">            handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a0b20babd45d1ef5d8ec42e3d54f14f89">on_feed_done</a>((<span class="keywordtype">void</span> *)handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a5b71a6ec147c6c8d4784f254c5441bcf">user_data</a>, handle, blob, -ECANCELED);</div>
<div class="line">        <a class="code" href="group__Types.html#gaaf14a0023ae6a06a7e9960e5b622a2ad">sol_blob_unref</a>(blob);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Last chance to consume the rx buffer</span></div>
<div class="line">    <span class="keywordflow">if</span> (handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>.<a class="code" href="structsol__buffer.html#a50844b0cbc4ae956fd4335537756bfa9">used</a>)</div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#aef373a1c0e8d436eda86d26598c33e7b">on_data</a>((<span class="keywordtype">void</span> *)handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a5b71a6ec147c6c8d4784f254c5441bcf">user_data</a>, handle, &amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>);</div>
<div class="line"></div>
<div class="line">    <a name="a68"></a><a class="code" href="group__PointerVector.html#gae3679db0985ec998a606e18ec5e26d15">sol_ptr_vector_clear</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a67ae8e9c83e8309a3da87c5df739558a">pending_blobs</a>);</div>
<div class="line">    <a name="a69"></a><a class="code" href="group__Buffer.html#ga957a46b424be4d7b7f044a2156120253">sol_buffer_fini</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>);</div>
<div class="line">    free(handle);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line"><a class="code" href="stream__sample_8c.html#a86de373ce01d0d7b8bee9b849e80881b">my_stream_api_close</a>(<span class="keyword">struct</span> <a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group__Log.html#gacb48844cf78438b772f069c089836835">SOL_NULL_CHECK</a>(handle);</div>
<div class="line">    <a class="code" href="group__Log.html#ga7ceb60c9648222c6d1fa660ec9fc1fe6">SOL_EXP_CHECK</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abe5c53a9b38f4b6c1d2d6f6105a4d78c">reentrant</a>.<a class="code" href="structsol__reentrant.html#a3b0f6f7122f0a296a1f8d5628072c6bc">delete_me</a>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abf5df3c3e80848524bcc63193da0469c">read_timeout</a>) {</div>
<div class="line">        <a name="a70"></a><a class="code" href="group__Mainloop.html#gae1f45ba3de62603e90903d1214cf834f">sol_timeout_del</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abf5df3c3e80848524bcc63193da0469c">read_timeout</a>);</div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abf5df3c3e80848524bcc63193da0469c">read_timeout</a> = NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a3c24f022235965c0d0463c6205d5e63e">read_monitor</a>) {</div>
<div class="line">        <a name="a71"></a><a class="code" href="stream__sample_8c.html#aaf09ef4a61479f0f07e2c98f0a44e413">my_stream_device_remove_io_monitor</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a3c24f022235965c0d0463c6205d5e63e">read_monitor</a>);</div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a3c24f022235965c0d0463c6205d5e63e">read_monitor</a> = NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a6730010206b507c04b52945c7a726248">write_monitor</a>) {</div>
<div class="line">        <a class="code" href="stream__sample_8c.html#aaf09ef4a61479f0f07e2c98f0a44e413">my_stream_device_remove_io_monitor</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a6730010206b507c04b52945c7a726248">write_monitor</a>);</div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a6730010206b507c04b52945c7a726248">write_monitor</a> = NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">//The user is trying to delete the handle from the on_data, do not delete it now.</span></div>
<div class="line">    <a class="code" href="group__Reentrant.html#ga6b0fac049a35897fc6d6551fb72e3eb7">SOL_REENTRANT_FREE</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abe5c53a9b38f4b6c1d2d6f6105a4d78c">reentrant</a>) {</div>
<div class="line">        <a class="code" href="stream__sample_8c.html#ac0e72426d06273925e202bfef56a127d">api_close</a>(handle);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="a72"></a><a class="code" href="message-digest_8c.html#a1ca30c9c5f198c738b568cdf304f6bd8">on_feed_done</a>(<span class="keywordtype">void</span> *data, <span class="keyword">struct</span> <a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle, <span class="keyword">struct</span> <a class="code" href="structsol__blob.html">sol_blob</a> *blob, <span class="keywordtype">int</span> status)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a name="_a73"></a><a class="code" href="structsol__str__slice.html">sol_str_slice</a> slice = <a name="a74"></a><a class="code" href="group__Str__Slice.html#gafc4606ede8c6c6bf264e71b08f0338e7">sol_str_slice_from_blob</a>(blob);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (status  &lt; 0)</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not send the blob data: %.*s. Reason: %s&quot;</span>,</div>
<div class="line">            <a name="a75"></a><a class="code" href="group__Str__Slice.html#ga10c9d829c4d0c50467106a14190d7611">SOL_STR_SLICE_PRINT</a>(slice), <a name="a76"></a><a class="code" href="group__Utils.html#gab584188ab3f38605dab8b04aaa85913d">sol_util_strerrora</a>(-status));</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        printf(<span class="stringliteral">&quot;\n&#39;%.*s&#39; Sent to stdout\n&quot;</span>, <a class="code" href="group__Str__Slice.html#ga10c9d829c4d0c50467106a14190d7611">SOL_STR_SLICE_PRINT</a>(slice));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *<a name="a77"></a><a class="code" href="stream__sample_8c.html#a9794fd48f4d5ded09617a95d86ef154d">out_handle</a>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> ssize_t</div>
<div class="line"><a name="a78"></a><a class="code" href="stream__sample_8c.html#a29596b98823f06a7a9ec2c2874aa52b4">on_data</a>(<span class="keywordtype">void</span> *<a class="code" href="structmy__stream__api__handle.html#a5b71a6ec147c6c8d4784f254c5441bcf">user_data</a>, <span class="keyword">struct</span> <a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structsol__buffer.html">sol_buffer</a> *buf)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structsol__str__slice.html">sol_str_slice</a> slice = <a name="a79"></a><a class="code" href="group__Buffer.html#ga8514e78d12dbe8c959af39de05f7c547">sol_buffer_get_slice</a>(buf);</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structsol__blob.html">sol_blob</a> *blob;</div>
<div class="line">    <span class="keywordtype">char</span> *sep;</div>
<div class="line"></div>
<div class="line">    sep = memchr(slice.<a name="a80"></a><a class="code" href="structsol__str__slice.html#a38ae63b741a375104ae7cc3a5da911a4">data</a>, <span class="charliteral">&#39;\n&#39;</span>, slice.<a name="a81"></a><a class="code" href="structsol__str__slice.html#a9b9f38d8d946af896daf76fab04473b7">len</a>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!sep)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">    slice.<a class="code" href="structsol__str__slice.html#a9b9f38d8d946af896daf76fab04473b7">len</a> = sep - slice.<a class="code" href="structsol__str__slice.html#a38ae63b741a375104ae7cc3a5da911a4">data</a>;</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;Received data &#39;%.*s&#39;. Sending to stdout.\n&quot;</span>, <a class="code" href="group__Str__Slice.html#ga10c9d829c4d0c50467106a14190d7611">SOL_STR_SLICE_PRINT</a>(slice));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a82"></a><a class="code" href="group__Str__Slice.html#ga80d120c6bf5edb6ded99ecfa5700afb2">sol_str_slice_str_eq</a>(slice, <span class="stringliteral">&quot;Bye&quot;</span>)) {</div>
<div class="line">        <a class="code" href="stream__sample_8c.html#a86de373ce01d0d7b8bee9b849e80881b">my_stream_api_close</a>(handle);</div>
<div class="line">        printf(<span class="stringliteral">&quot;Closing the input stream\n&quot;</span>);</div>
<div class="line">        <a name="a83"></a><a class="code" href="group__Mainloop.html#ga56c31320e4348c91a719039b5a22dd25">sol_quit</a>();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    blob = <a name="a84"></a><a class="code" href="group__Types.html#ga42c9abd2ff9950e7ac828c313fb758c9">sol_blob_new</a>(&amp;<a name="a85"></a><a class="code" href="group__Types.html#ga75304e1941290fd8e20afd56c71d07cb">SOL_BLOB_TYPE_NO_FREE_DATA</a>, NULL, slice.<a class="code" href="structsol__str__slice.html#a38ae63b741a375104ae7cc3a5da911a4">data</a>, slice.<a class="code" href="structsol__str__slice.html#a9b9f38d8d946af896daf76fab04473b7">len</a>);</div>
<div class="line">    <span class="keywordflow">if</span> (!blob) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not create a blob to send to stdout&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="stream__sample_8c.html#a639e091ebfcde41608de7db1e247c9f6">my_stream_api_feed</a>(out_handle, blob);</div>
<div class="line">    <a class="code" href="group__Types.html#gaaf14a0023ae6a06a7e9960e5b622a2ad">sol_blob_unref</a>(blob);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> slice.<a class="code" href="structsol__str__slice.html#a9b9f38d8d946af896daf76fab04473b7">len</a> + 1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="a86"></a><a class="code" href="browse_8c.html#a8f65ca9f5a72be7fe776126fc632f8a9">startup</a>(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *in_handle;</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structmy__stream__api__config.html">my_stream_api_config</a> in_config = {</div>
<div class="line">        .<a class="code" href="structmy__stream__api__config.html#a0a29a85be0f186c3b1c6a366fcc49fd4">on_data</a> = <a class="code" href="stream__sample_8c.html#a29596b98823f06a7a9ec2c2874aa52b4">on_data</a>,</div>
<div class="line">    };</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structmy__stream__api__config.html">my_stream_api_config</a> out_config = {</div>
<div class="line">        .<a class="code" href="structmy__stream__api__config.html#a309cd33a61e1661a78afed9339b23b6d">on_feed_done</a> = <a class="code" href="message-digest_8c.html#a1ca30c9c5f198c738b568cdf304f6bd8">on_feed_done</a>,</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    in_handle = <a class="code" href="stream__sample_8c.html#a3998878d95b5e5642e93b9e764160095">my_stream_api_new</a>(&amp;in_config, STDIN_FILENO);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!in_handle) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not create the input stream\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">goto</span> err_in;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    out_handle = <a class="code" href="stream__sample_8c.html#a3998878d95b5e5642e93b9e764160095">my_stream_api_new</a>(&amp;out_config, STDOUT_FILENO);</div>
<div class="line">    <span class="keywordflow">if</span> (!out_handle) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not create the output stream\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">goto</span> err_out;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;Type some text and press enter.\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">err_out:</div>
<div class="line">    <a class="code" href="stream__sample_8c.html#a86de373ce01d0d7b8bee9b849e80881b">my_stream_api_close</a>(in_handle);</div>
<div class="line">err_in:</div>
<div class="line">    <a name="a87"></a><a class="code" href="group__Mainloop.html#gab1deec1c7e4da3b7b8caeafe9369b816">sol_quit_with_code</a>(EXIT_FAILURE);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="a88"></a><a class="code" href="browse_8c.html#af80085e2fde103b0fcdf58fcab027e47">shutdown</a>(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><a name="a89"></a><a class="code" href="group__Mainloop.html#ga54818bc87ca55fe50e3732f52b56e009">SOL_MAIN_DEFAULT</a>(<a class="code" href="browse_8c.html#a8f65ca9f5a72be7fe776126fc632f8a9">startup</a>, <a class="code" href="browse_8c.html#af80085e2fde103b0fcdf58fcab027e47">shutdown</a>);</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- HTML footer for doxygen 1.8.9.1-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
<a href="http://solettaproject.github.io/docs/">Full online documentation</a> | 
<a href="index.html">C API Index</a>
</small></address>
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
