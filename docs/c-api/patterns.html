<!-- HTML header for doxygen 1.8.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Soletta™ Framework: Design Patterns</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Soletta™ Framework
   </div>
   <div id="projectbrief">
   Framework for making IoT devices<br /><br />
   <small>
   <a href="http://solettaproject.github.io/docs/">Full online documentation</a> | 
   <a href="index.html">C API Index</a>
   </small><br />
   </div>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Design Patterns </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#streams">IO Streams</a><ul><li class="level2"><a href="#config">Configuration</a></li>
<li class="level2"><a href="#write">Writing</a></li>
<li class="level2"><a href="#read">Reading</a></li>
<li class="level2"><a href="#usage">Usage Example</a></li>
<li class="level2"><a href="#implementations">Implementations</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>This page will explain the common design patterns employed by Soletta.</p>
<h1><a class="anchor" id="streams"></a>
IO Streams</h1>
<p>Soletta has its own pattern for dealing with input/output streams. This section will describe how the soletta pattern is implemented and how to use it.</p>
<p>The aim of this section is to guide the developer to provide a unified API for all kind of streams, making it easier for a third party developer to migrate its application to any stream related IO, if necessary.</p>
<p>The pattern is divided in three categories: The stream configuration, the write API and the read API.</p>
<h2><a class="anchor" id="config"></a>
Configuration</h2>
<p>The stream should be configured using a struct during its creation, this struct should provide the following fields.</p>
<ul>
<li>
<code>feed_size:</code> The write buffer size - If <code>0</code> means that there is no limit (Data for this buffer is not necessary allocated). </li>
<li>
<code>data_buffer_size:</code> The read buffer size. This buffer is always allocated and the <code>on_data</code> may be called with at most <code>data_buffer_size</code> bytes - If <code>0</code> means that there is not limit. </li>
<li>
<code>on_feed_done:</code> The write callback - It will be called when data was fully written. <ul>
<li>
Respecting the interface: <div class="fragment"><div class="line">void (*<a class="code" href="message-digest_8c.html#a1ca30c9c5f198c738b568cdf304f6bd8">on_feed_done</a>)(<span class="keywordtype">void</span> *user_data, <a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle, <span class="keyword">struct </span><a class="code" href="structsol__blob.html">sol_blob</a> *blob, <span class="keywordtype">int</span> status);</div>
</div><!-- fragment --> </li>
</ul>
</li>
<li>
<code>on_data:</code> The read callback - It will be called when there's data available to read. <ul>
<li>
Respecting the interface: <div class="fragment"><div class="line">ssize_t (*<a class="code" href="stream__sample_8c.html#a29596b98823f06a7a9ec2c2874aa52b4">on_data</a>)(<span class="keywordtype">void</span> *user_data, <a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle, <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structsol__buffer.html">sol_buffer</a> *buf);</div>
</div><!-- fragment --> </li>
</ul>
</li>
<li>
<code>user_data:</code> Data to <code>on_data</code> and <code>on_feed_done</code>. </li>
</ul>
<p>Below there's a example of a configuration struct. </p>
<div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code" href="structmy__stream__api__config.html">my_stream_api_config</a> {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structmy__stream__api__config.html#a305b6d602ae19a82c20d2228d8c3eba9">user_data</a>;</div>
<div class="line">    void (*<a class="code" href="structmy__stream__api__config.html#a309cd33a61e1661a78afed9339b23b6d">on_feed_done</a>)(<span class="keywordtype">void</span> *<a class="code" href="structmy__stream__api__config.html#a305b6d602ae19a82c20d2228d8c3eba9">user_data</a>, <span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle, <span class="keyword">struct </span><a class="code" href="structsol__blob.html">sol_blob</a> *blob, <span class="keywordtype">int</span> status);</div>
<div class="line">    ssize_t (*<a class="code" href="structmy__stream__api__config.html#a0a29a85be0f186c3b1c6a366fcc49fd4">on_data</a>)(<span class="keywordtype">void</span> *<a class="code" href="structmy__stream__api__config.html#a305b6d602ae19a82c20d2228d8c3eba9">user_data</a>, <span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle, <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structsol__buffer.html">sol_buffer</a> *buf);</div>
<div class="line">    <span class="keywordtype">size_t</span> <a class="code" href="structmy__stream__api__config.html#ae6ab80cb4784977da1c86cee04b5cb71">feed_size</a>;</div>
<div class="line">    <span class="keywordtype">size_t</span> <a class="code" href="structmy__stream__api__config.html#aa5f21fc73373f77c21d91004bea31dd3">data_buffer_size</a>;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *<a class="code" href="stream__sample_8c.html#a3998878d95b5e5642e93b9e764160095">my_stream_api_new</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmy__stream__api__config.html">my_stream_api_config</a> *config, <span class="keywordtype">int</span> <a class="code" href="structmy__stream__api__handle.html#af9f3eba48475670675524341901fde7d">dev</a>);</div>
</div><!-- fragment --> <h2><a class="anchor" id="write"></a>
Writing</h2>
<p>Write operations must be async and the data that will be transferred must be provided as a pointer to <a class="el" href="structsol__blob.html">sol_blob</a>. One should follow the API below: </p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="stream__sample_8c.html#a639e091ebfcde41608de7db1e247c9f6">my_stream_api_feed</a>(<span class="keyword">struct</span> <a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle, <span class="keyword">struct</span> <a class="code" href="structsol__blob.html">sol_blob</a> *blob);</div>
</div><!-- fragment --><p> Every blob requested to be written, must be queued in order to be sent. If there's no more space to queue more blobs (sum of all queued blobs &gt;= <code>feed_size</code>) the function write should return <code>-ENOSPC</code>.</p>
<p>Every time a blob is fully written the <code>on_feed_done</code> must be called in order to inform the user that the write operation was completed. The <code>on_feed_done</code> should have the following signature:</p>
<div class="fragment"><div class="line">void (*<a class="code" href="message-digest_8c.html#a1ca30c9c5f198c738b568cdf304f6bd8">on_feed_done</a>)(<span class="keywordtype">void</span> *<a class="code" href="structmy__stream__api__handle.html#a5b71a6ec147c6c8d4784f254c5441bcf">user_data</a>, <a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle, <span class="keyword">struct </span><a class="code" href="structsol__blob.html">sol_blob</a> *blob, <span class="keywordtype">int</span> status);</div>
</div><!-- fragment --><p>One should warn the user that it's not necessary to use <a class="el" href="group__Types.html#gaaf14a0023ae6a06a7e9960e5b622a2ad">sol_blob_unref()</a>, because the stream API will already do that. The <code>status</code> variable should be 0 on success and <code>-errno</code> on error. The user should be able to cancel the stream operation from the <code>on_feed_done</code>.</p>
<p>Below there's an example of a stream device write implementation.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structmy__stream__api__handle.html#a5b71a6ec147c6c8d4784f254c5441bcf">user_data</a>;</div>
<div class="line">    void (*<a class="code" href="structmy__stream__api__handle.html#a0b20babd45d1ef5d8ec42e3d54f14f89">on_feed_done</a>)(<span class="keywordtype">void</span> *<a class="code" href="structmy__stream__api__handle.html#a5b71a6ec147c6c8d4784f254c5441bcf">user_data</a>, <span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle, <span class="keyword">struct </span><a class="code" href="structsol__blob.html">sol_blob</a> *blob, <span class="keywordtype">int</span> status);</div>
<div class="line">    ssize_t (*<a class="code" href="structmy__stream__api__handle.html#aef373a1c0e8d436eda86d26598c33e7b">on_data</a>)(<span class="keywordtype">void</span> *<a class="code" href="structmy__stream__api__handle.html#a5b71a6ec147c6c8d4784f254c5441bcf">user_data</a>, <span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle, <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structsol__buffer.html">sol_buffer</a> *buf);</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="group__Mainloop.html#ga40dddc147a0d6370aeb8219a90b56596">sol_timeout</a> *<a class="code" href="structmy__stream__api__handle.html#abf5df3c3e80848524bcc63193da0469c">read_timeout</a>;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structsol__buffer.html">sol_buffer</a> <a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structsol__ptr__vector.html">sol_ptr_vector</a> <a class="code" href="structmy__stream__api__handle.html#a67ae8e9c83e8309a3da87c5df739558a">pending_blobs</a>;</div>
<div class="line">    <a class="code" href="stream__sample_8c.html#a84ef4c43fe6ed66f0a11d5c9e473070e">my_stream_device_monitor_handle</a> *<a class="code" href="structmy__stream__api__handle.html#a3c24f022235965c0d0463c6205d5e63e">read_monitor</a>;</div>
<div class="line">    <a class="code" href="stream__sample_8c.html#a84ef4c43fe6ed66f0a11d5c9e473070e">my_stream_device_monitor_handle</a> *<a class="code" href="structmy__stream__api__handle.html#a6730010206b507c04b52945c7a726248">write_monitor</a>;</div>
<div class="line">    <span class="keywordtype">size_t</span> <a class="code" href="structmy__stream__api__handle.html#ab6cc8c06107f968fd5af69d3a9dfe0b6">feed_size</a>;</div>
<div class="line">    <span class="keywordtype">size_t</span> <a class="code" href="structmy__stream__api__handle.html#a0eb24dfcdd091f843f534f6f79f83325">pending_bytes</a>;</div>
<div class="line">    <span class="keywordtype">size_t</span> <a class="code" href="structmy__stream__api__handle.html#aea5e303a5ce8020904a03363e329f8f2">written</a>;</div>
<div class="line">    <span class="keywordtype">int</span> <a class="code" href="structmy__stream__api__handle.html#af9f3eba48475670675524341901fde7d">dev</a>;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structsol__reentrant.html">sol_reentrant</a> <a class="code" href="structmy__stream__api__handle.html#abe5c53a9b38f4b6c1d2d6f6105a4d78c">reentrant</a>;</div>
<div class="line">};</div>
</div><!-- fragment --><div class="fragment"><div class="line"></div>
<div class="line"><span class="comment">//The write operation itself</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span></div>
<div class="line"><a class="code" href="stream__sample_8c.html#a59c664cac2d659cbe290e218c870318f">_can_write</a>(<span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> <a class="code" href="download_8c.html#a600b792d6d2ff2e71096dfa60d97a3b0">fd</a>, uint32_t active_flags)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle = data;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structsol__blob.html">sol_blob</a> *blob;</div>
<div class="line">    ssize_t status;</div>
<div class="line">    <span class="keywordtype">bool</span> r = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Write the blob</span></div>
<div class="line">    blob = <a class="code" href="group__PointerVector.html#gae21a26f15b2b3d2dd818dba89f42b4f3">sol_ptr_vector_get</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a67ae8e9c83e8309a3da87c5df739558a">pending_blobs</a>, 0);</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Write into the stream</span></div>
<div class="line">    status = <a class="code" href="stream__sample_8c.html#a310d6b8f1ff08b8d06b49680d936fce7">my_stream_device_write</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#af9f3eba48475670675524341901fde7d">dev</a>, (<span class="keywordtype">char</span> *)blob-&gt;<a class="code" href="structsol__blob.html#a902b9909ebabd0cc784ce0d9f64c6940">mem</a> + handle-&gt;<a class="code" href="structmy__stream__api__handle.html#aea5e303a5ce8020904a03363e329f8f2">written</a>, blob-&gt;<a class="code" href="structsol__blob.html#aa708cb5e0186b24dc4eee1a4669577b7">size</a>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (status &lt; 0) {</div>
<div class="line">        <span class="keywordflow">if</span> (status == EAGAIN || status == EINTR)</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">        <span class="keywordflow">else</span> {</div>
<div class="line">            <a class="code" href="group__Log.html#ga5d9529e9746395acc2cd96a28ffa1c28">SOL_WRN</a>(<span class="stringliteral">&quot;Could not write to the stream device!&quot;</span>);</div>
<div class="line">            handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a6730010206b507c04b52945c7a726248">write_monitor</a> = NULL;</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Update how many bytes have been written</span></div>
<div class="line">    handle-&gt;<a class="code" href="structmy__stream__api__handle.html#aea5e303a5ce8020904a03363e329f8f2">written</a> += status;</div>
<div class="line">    handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a0eb24dfcdd091f843f534f6f79f83325">pending_bytes</a> -= status;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Blob was completly written. Inform the user.</span></div>
<div class="line">    <span class="keywordflow">if</span> (handle-&gt;<a class="code" href="structmy__stream__api__handle.html#aea5e303a5ce8020904a03363e329f8f2">written</a> == blob-&gt;<a class="code" href="structsol__blob.html#aa708cb5e0186b24dc4eee1a4669577b7">size</a>) {</div>
<div class="line">        <span class="comment">//Do we still have more data ?</span></div>
<div class="line">        <a class="code" href="group__PointerVector.html#gabf7e6eee8dc6d91c9ba1c07f13eb7f81">sol_ptr_vector_del</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a67ae8e9c83e8309a3da87c5df739558a">pending_blobs</a>, 0);</div>
<div class="line">        <span class="keywordflow">if</span> (!<a class="code" href="group__PointerVector.html#ga979ef2866af8cc57b616f125c0a16ea7">sol_ptr_vector_get_len</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a67ae8e9c83e8309a3da87c5df739558a">pending_blobs</a>)) {</div>
<div class="line">            r = <span class="keyword">false</span>;</div>
<div class="line">            handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a6730010206b507c04b52945c7a726248">write_monitor</a> = NULL;</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">//Reset the written counter</span></div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#aea5e303a5ce8020904a03363e329f8f2">written</a> = 0;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">           Inform the user.</span></div>
<div class="line"><span class="comment">           Since it&#39;s completly safe to call my_stream_api_close() inside on_feed_done().</span></div>
<div class="line"><span class="comment">           Informing the user should be the last thing to do.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">if</span> (handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a0b20babd45d1ef5d8ec42e3d54f14f89">on_feed_done</a>)</div>
<div class="line">            handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a0b20babd45d1ef5d8ec42e3d54f14f89">on_feed_done</a>((<span class="keywordtype">void</span> *)handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a5b71a6ec147c6c8d4784f254c5441bcf">user_data</a>, handle, blob, status);</div>
<div class="line">        <a class="code" href="group__Types.html#gaaf14a0023ae6a06a7e9960e5b622a2ad">sol_blob_unref</a>(blob); <span class="comment">//NOTE: that we unref the blob, not the user!</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> r;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line"><a class="code" href="stream__sample_8c.html#a639e091ebfcde41608de7db1e247c9f6">my_stream_api_feed</a>(<span class="keyword">struct</span> <a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle, <span class="keyword">struct</span> <a class="code" href="structsol__blob.html">sol_blob</a> *blob)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">size_t</span> total;</div>
<div class="line">    <span class="keywordtype">int</span> r;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group__Log.html#gacb48844cf78438b772f069c089836835">SOL_NULL_CHECK</a>(handle, -EINVAL);</div>
<div class="line">    <a class="code" href="group__Log.html#gacb48844cf78438b772f069c089836835">SOL_NULL_CHECK</a>(blob, -EINVAL);</div>
<div class="line">    <span class="comment">//Do not try to write with the uart is going to be closed</span></div>
<div class="line">    <a class="code" href="group__Log.html#ga7ceb60c9648222c6d1fa660ec9fc1fe6">SOL_EXP_CHECK</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abe5c53a9b38f4b6c1d2d6f6105a4d78c">reentrant</a>.<a class="code" href="structsol__reentrant.html#a3b0f6f7122f0a296a1f8d5628072c6bc">delete_me</a>, -EINVAL);</div>
<div class="line"></div>
<div class="line">    total = handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a0eb24dfcdd091f843f534f6f79f83325">pending_bytes</a> + blob-&gt;<a class="code" href="structsol__blob.html#aa708cb5e0186b24dc4eee1a4669577b7">size</a>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//feed_size was set and the total must not exceed feed_size</span></div>
<div class="line">    <span class="keywordflow">if</span> (handle-&gt;<a class="code" href="structmy__stream__api__handle.html#ab6cc8c06107f968fd5af69d3a9dfe0b6">feed_size</a> &amp;&amp; total &gt;= handle-&gt;<a class="code" href="structmy__stream__api__handle.html#ab6cc8c06107f968fd5af69d3a9dfe0b6">feed_size</a>)</div>
<div class="line">        <span class="keywordflow">return</span> -ENOSPC; <span class="comment">//Try again later</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">//Store the blob and ref it, since it will written later.</span></div>
<div class="line">    r = <a class="code" href="group__PointerVector.html#gab48f4a05d4101d836375dcf7106aaa00">sol_ptr_vector_append</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a67ae8e9c83e8309a3da87c5df739558a">pending_blobs</a>, blob);</div>
<div class="line">    <a class="code" href="group__Log.html#ga8b7a2ba17c9bf66ad98238f0ca591413">SOL_INT_CHECK</a>(r, &lt; 0, r);</div>
<div class="line">    <a class="code" href="group__Types.html#ga4037a7e2e24c7f74c92bea431035776d">sol_blob_ref</a>(blob);</div>
<div class="line">    handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a0eb24dfcdd091f843f534f6f79f83325">pending_bytes</a> = total;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Schedule the write operation</span></div>
<div class="line">    <span class="keywordflow">if</span> (!handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a6730010206b507c04b52945c7a726248">write_monitor</a>) {</div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a6730010206b507c04b52945c7a726248">write_monitor</a> = <a class="code" href="stream__sample_8c.html#a5ced3281145daa31ecbf232f4ea7b84a">my_stream_device_add_io_monitor</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#af9f3eba48475670675524341901fde7d">dev</a>,</div>
<div class="line">            SOL_FD_FLAGS_OUT, <a class="code" href="stream__sample_8c.html#a59c664cac2d659cbe290e218c870318f">_can_write</a>, handle);</div>
<div class="line">        <a class="code" href="group__Log.html#ga54e82836a0158b537774689043b0fb75">SOL_NULL_CHECK_GOTO</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a6730010206b507c04b52945c7a726248">write_monitor</a>, err_monitor);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">err_monitor:</div>
<div class="line">    <a class="code" href="group__PointerVector.html#gafd8d8290ff6aef284c8aa6a664088826">sol_ptr_vector_del_element</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a67ae8e9c83e8309a3da87c5df739558a">pending_blobs</a>, blob);</div>
<div class="line">    <a class="code" href="group__Types.html#gaaf14a0023ae6a06a7e9960e5b622a2ad">sol_blob_unref</a>(blob);</div>
<div class="line">    <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">}</div>
<div class="line"></div>
</div><!-- fragment --> <h2><a class="anchor" id="read"></a>
Reading</h2>
<p>Since this is a stream, there's no direct way for a third party developer to request a read operation. In order to be able to read from the stream, the third party developer must provide the <code>on_data</code> duration the stream configuration/creation. The <code>on_data</code> is provided during the stream creation, one must inform the user every time data is avaible to read. The <code>on_data</code> has the following signature:</p>
<div class="fragment"><div class="line">ssize_t (*<a class="code" href="stream__sample_8c.html#a29596b98823f06a7a9ec2c2874aa52b4">on_data</a>)(<span class="keywordtype">void</span> *user_data, <a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle, <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structsol__buffer.html">sol_buffer</a> *buf);</div>
</div><!-- fragment --><p>Note that the <code>on_data</code> returns a <code>ssize_t</code>, the returned value must be <code>-errno</code> if an error happened or the number of bytes consumed from <code>buf</code> (0 is valid). The consumed bytes will be removed from the <code>buf</code>. It's important to note that the <code>buf</code> should not be modified and any references to its data should not be kept after <code>on_data</code> returns. Also just like <code>on_feed_done</code>, the user should be able to close/delete the stream handle inside <code>on_data</code>. Extra care must be taken in order to do not crash.</p>
<p>Below there's an example of the stream device read implementation.</p>
<div class="fragment"><div class="line"><span class="comment">//Delivery the data to the user</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span></div>
<div class="line"><a class="code" href="stream__sample_8c.html#a2f9f4d9b9c23b6a058b614a3f8a18dd9">_inform_user</a>(<span class="keywordtype">void</span> *data)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle = data;</div>
<div class="line">    ssize_t r;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Flag that the handle is in use</span></div>
<div class="line">    <a class="code" href="group__Reentrant.html#ga9ea2042382ce22b3f8bc086bc211e792">SOL_REENTRANT_CALL</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abe5c53a9b38f4b6c1d2d6f6105a4d78c">reentrant</a>) {</div>
<div class="line">        <span class="comment">//Inform the user</span></div>
<div class="line">        r = handle-&gt;<a class="code" href="structmy__stream__api__handle.html#aef373a1c0e8d436eda86d26598c33e7b">on_data</a>((<span class="keywordtype">void</span> *)handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a5b71a6ec147c6c8d4784f254c5441bcf">user_data</a>, handle, &amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Remove the data.</span></div>
<div class="line">    <span class="keywordflow">if</span> (r &lt; 0)</div>
<div class="line">        <a class="code" href="group__Log.html#ga823cf64eb1674aa6f3337e05563d5929">SOL_ERR</a>(<span class="stringliteral">&quot;Something wrong happened %zd&quot;</span>, r);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <a class="code" href="group__Buffer.html#ga4c5ac235da1f72ad8866570723eeb8a3">sol_buffer_remove_data</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>, 0, r);</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Close the handle</span></div>
<div class="line">    <span class="keywordflow">if</span> (handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abe5c53a9b38f4b6c1d2d6f6105a4d78c">reentrant</a>.<a class="code" href="structsol__reentrant.html#a3b0f6f7122f0a296a1f8d5628072c6bc">delete_me</a>) {</div>
<div class="line">        <a class="code" href="group__Reentrant.html#ga6b0fac049a35897fc6d6551fb72e3eb7">SOL_REENTRANT_FREE</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abe5c53a9b38f4b6c1d2d6f6105a4d78c">reentrant</a>) {</div>
<div class="line">            <a class="code" href="stream__sample_8c.html#ac0e72426d06273925e202bfef56a127d">api_close</a>(handle);</div>
<div class="line">        }</div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abf5df3c3e80848524bcc63193da0469c">read_timeout</a> = NULL;</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Still need to callback the user with remaining data, keep the timer running</span></div>
<div class="line">    <span class="keywordflow">if</span> (handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>.<a class="code" href="structsol__buffer.html#a50844b0cbc4ae956fd4335537756bfa9">used</a>)</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abf5df3c3e80848524bcc63193da0469c">read_timeout</a> = NULL;</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//Actually read from the device</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span></div>
<div class="line"><a class="code" href="stream__sample_8c.html#ab36534599cf0df085cd00606e29173f8">_can_read</a>(<span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> fd, uint32_t active_flags)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle = data;</div>
<div class="line">    <span class="keywordtype">size_t</span> remaining = handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>.<a class="code" href="structsol__buffer.html#a5da3d12dd7be7f032c8f4ad4a7e5975b">capacity</a> - handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>.<a class="code" href="structsol__buffer.html#a50844b0cbc4ae956fd4335537756bfa9">used</a>;</div>
<div class="line">    ssize_t status;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//The rx buffer is full. Try to expand it in order to store more data.</span></div>
<div class="line">    <span class="keywordflow">if</span> (!remaining &amp;&amp; !(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>.<a class="code" href="structsol__buffer.html#a1efd437e9b7844cc5d120b4204bd53cd">flags</a> &amp; <a class="code" href="group__Buffer.html#ggaa7349ebf92ae19e234119719eb74e9beaedd472f65c286fd8b066d6e8ff2b1789">SOL_BUFFER_FLAGS_FIXED_CAPACITY</a>)) {</div>
<div class="line">        <span class="keywordtype">int</span> err;</div>
<div class="line"></div>
<div class="line">        err = <a class="code" href="group__Buffer.html#ga6cfddb6d81fec1263637b02e441a0f64">sol_buffer_expand</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>, <a class="code" href="stream__sample_8c.html#a6e576a3c6530636d68b7a220480bcd32">DEFAULT_BUFFER_SIZE</a>);</div>
<div class="line">        <a class="code" href="group__Log.html#ga8b7a2ba17c9bf66ad98238f0ca591413">SOL_INT_CHECK</a>(err, &lt; 0, <span class="keyword">true</span>);</div>
<div class="line">        remaining = <a class="code" href="stream__sample_8c.html#a6e576a3c6530636d68b7a220480bcd32">DEFAULT_BUFFER_SIZE</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (remaining &gt; 0) {</div>
<div class="line">        <span class="comment">//Append data to the buffer</span></div>
<div class="line">        status = <a class="code" href="stream__sample_8c.html#a060d10833a9dab8f63d11aec7bc00bf1">my_stream_device_read</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#af9f3eba48475670675524341901fde7d">dev</a>, <a class="code" href="group__Buffer.html#gae055658101d5ea00251be938e22f8b92">sol_buffer_at_end</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>), remaining);</div>
<div class="line">        <span class="keywordflow">if</span> (status &lt; 0) {</div>
<div class="line">            <span class="keywordflow">if</span> (status == EAGAIN || status == EINTR)</div>
<div class="line">                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">            <span class="keywordflow">else</span> {</div>
<div class="line">                <a class="code" href="group__Log.html#ga5d9529e9746395acc2cd96a28ffa1c28">SOL_WRN</a>(<span class="stringliteral">&quot;Could not read to the stream device!&quot;</span>);</div>
<div class="line">                handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a3c24f022235965c0d0463c6205d5e63e">read_monitor</a> = NULL;</div>
<div class="line">                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>.<a class="code" href="structsol__buffer.html#a50844b0cbc4ae956fd4335537756bfa9">used</a> += status;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abf5df3c3e80848524bcc63193da0469c">read_timeout</a>)</div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abf5df3c3e80848524bcc63193da0469c">read_timeout</a> = <a class="code" href="group__Mainloop.html#ga9d0cd6af9dab4da3002e5cd596ce604f">sol_timeout_add</a>(0, <a class="code" href="stream__sample_8c.html#a2f9f4d9b9c23b6a058b614a3f8a18dd9">_inform_user</a>, handle);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//Stream creation, where on_data is configured</span></div>
<div class="line"><span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *</div>
<div class="line"><a class="code" href="stream__sample_8c.html#a3998878d95b5e5642e93b9e764160095">my_stream_api_new</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmy__stream__api__config.html">my_stream_api_config</a> *config, <span class="keywordtype">int</span> <a class="code" href="structmy__stream__api__handle.html#af9f3eba48475670675524341901fde7d">dev</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle;</div>
<div class="line">    <span class="keywordtype">size_t</span> data_buffer_size = 0;</div>
<div class="line">    <span class="keywordtype">void</span> *buf = NULL;</div>
<div class="line">    <span class="comment">//By default the rx buffer will not be limited</span></div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="group__Buffer.html#gaa7349ebf92ae19e234119719eb74e9be">sol_buffer_flags</a> flags = <a class="code" href="group__Buffer.html#ggaa7349ebf92ae19e234119719eb74e9beafd1d0f37242c92450c0e596c17a80dc8">SOL_BUFFER_FLAGS_NO_NUL_BYTE</a> | <a class="code" href="group__Buffer.html#ggaa7349ebf92ae19e234119719eb74e9bea2f0b03321abe3527160986cb213ab520">SOL_BUFFER_FLAGS_DEFAULT</a>;</div>
<div class="line"></div>
<div class="line">    handle = calloc(1, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a>));</div>
<div class="line">    <a class="code" href="group__Log.html#gacb48844cf78438b772f069c089836835">SOL_NULL_CHECK</a>(handle, NULL);</div>
<div class="line"></div>
<div class="line">    handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a0b20babd45d1ef5d8ec42e3d54f14f89">on_feed_done</a> = config-&gt;<a class="code" href="structmy__stream__api__config.html#a309cd33a61e1661a78afed9339b23b6d">on_feed_done</a>;</div>
<div class="line">    handle-&gt;<a class="code" href="structmy__stream__api__handle.html#ab6cc8c06107f968fd5af69d3a9dfe0b6">feed_size</a> = config-&gt;<a class="code" href="structmy__stream__api__config.html#ae6ab80cb4784977da1c86cee04b5cb71">feed_size</a>;</div>
<div class="line">    handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a5b71a6ec147c6c8d4784f254c5441bcf">user_data</a> = config-&gt;<a class="code" href="structmy__stream__api__config.html#a305b6d602ae19a82c20d2228d8c3eba9">user_data</a>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//The user does not want to read from the stream, ignore rx configuration.</span></div>
<div class="line">    <span class="keywordflow">if</span> (config-&gt;<a class="code" href="structmy__stream__api__config.html#a0a29a85be0f186c3b1c6a366fcc49fd4">on_data</a>) {</div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#aef373a1c0e8d436eda86d26598c33e7b">on_data</a> = config-&gt;<a class="code" href="structmy__stream__api__config.html#a0a29a85be0f186c3b1c6a366fcc49fd4">on_data</a>;</div>
<div class="line">        data_buffer_size = config-&gt;<a class="code" href="structmy__stream__api__config.html#aa5f21fc73373f77c21d91004bea31dd3">data_buffer_size</a>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">//The rx buffer has a fixed size and we should respect that.</span></div>
<div class="line">        <span class="keywordflow">if</span> (data_buffer_size) {</div>
<div class="line">            buf = malloc(data_buffer_size);</div>
<div class="line">            <a class="code" href="group__Log.html#ga54e82836a0158b537774689043b0fb75">SOL_NULL_CHECK_GOTO</a>(buf, err_buf);</div>
<div class="line">            flags |= <a class="code" href="group__Buffer.html#ggaa7349ebf92ae19e234119719eb74e9beaedd472f65c286fd8b066d6e8ff2b1789">SOL_BUFFER_FLAGS_FIXED_CAPACITY</a>;</div>
<div class="line">        } <span class="comment">//else - The user is informing that the rx buffer should be unlimited</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">//Setup input monitor</span></div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a3c24f022235965c0d0463c6205d5e63e">read_monitor</a> = <a class="code" href="stream__sample_8c.html#a5ced3281145daa31ecbf232f4ea7b84a">my_stream_device_add_io_monitor</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#af9f3eba48475670675524341901fde7d">dev</a>, SOL_FD_FLAGS_IN, <a class="code" href="stream__sample_8c.html#ab36534599cf0df085cd00606e29173f8">_can_read</a>, handle);</div>
<div class="line">        <a class="code" href="group__Log.html#ga54e82836a0158b537774689043b0fb75">SOL_NULL_CHECK_GOTO</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a3c24f022235965c0d0463c6205d5e63e">read_monitor</a>, err_monitor);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group__Buffer.html#ga4eadd7e2b51c49dc19fa52d37e8776ba">sol_buffer_init_flags</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>, buf, data_buffer_size, flags);</div>
<div class="line">    <a class="code" href="group__PointerVector.html#gac398e94fafafaea31c54becda7b9b0c2">sol_ptr_vector_init</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a67ae8e9c83e8309a3da87c5df739558a">pending_blobs</a>);</div>
<div class="line">    handle-&gt;<a class="code" href="structmy__stream__api__handle.html#af9f3eba48475670675524341901fde7d">dev</a> = <a class="code" href="structmy__stream__api__handle.html#af9f3eba48475670675524341901fde7d">dev</a>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> handle;</div>
<div class="line"></div>
<div class="line">err_monitor:</div>
<div class="line">    free(buf);</div>
<div class="line">err_buf:</div>
<div class="line">    free(handle);</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a class="code" href="stream__sample_8c.html#ac0e72426d06273925e202bfef56a127d">api_close</a>(<span class="keyword">struct</span> <a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle)</div>
<div class="line">{</div>
<div class="line">    uint16_t i;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structsol__blob.html">sol_blob</a> *blob;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Inform that some blobs where not sent</span></div>
<div class="line">    <a class="code" href="group__PointerVector.html#gaf63bd1dc979cddb3c39d998c218993ed">SOL_PTR_VECTOR_FOREACH_IDX</a> (&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a67ae8e9c83e8309a3da87c5df739558a">pending_blobs</a>, blob, i) {</div>
<div class="line">        <span class="keywordflow">if</span> (handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a0b20babd45d1ef5d8ec42e3d54f14f89">on_feed_done</a>)</div>
<div class="line">            handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a0b20babd45d1ef5d8ec42e3d54f14f89">on_feed_done</a>((<span class="keywordtype">void</span> *)handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a5b71a6ec147c6c8d4784f254c5441bcf">user_data</a>, handle, blob, -ECANCELED);</div>
<div class="line">        <a class="code" href="group__Types.html#gaaf14a0023ae6a06a7e9960e5b622a2ad">sol_blob_unref</a>(blob);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Last chance to consume the rx buffer</span></div>
<div class="line">    <span class="keywordflow">if</span> (handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>.<a class="code" href="structsol__buffer.html#a50844b0cbc4ae956fd4335537756bfa9">used</a>)</div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#aef373a1c0e8d436eda86d26598c33e7b">on_data</a>((<span class="keywordtype">void</span> *)handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a5b71a6ec147c6c8d4784f254c5441bcf">user_data</a>, handle, &amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group__PointerVector.html#gae3679db0985ec998a606e18ec5e26d15">sol_ptr_vector_clear</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a67ae8e9c83e8309a3da87c5df739558a">pending_blobs</a>);</div>
<div class="line">    <a class="code" href="group__Buffer.html#ga957a46b424be4d7b7f044a2156120253">sol_buffer_fini</a>(&amp;handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a1d5b0cf0bf54d0f10bcb306365549729">rx</a>);</div>
<div class="line">    free(handle);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line"><a class="code" href="stream__sample_8c.html#a86de373ce01d0d7b8bee9b849e80881b">my_stream_api_close</a>(<span class="keyword">struct</span> <a class="code" href="structmy__stream__api__handle.html">my_stream_api_handle</a> *handle)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group__Log.html#gacb48844cf78438b772f069c089836835">SOL_NULL_CHECK</a>(handle);</div>
<div class="line">    <a class="code" href="group__Log.html#ga7ceb60c9648222c6d1fa660ec9fc1fe6">SOL_EXP_CHECK</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abe5c53a9b38f4b6c1d2d6f6105a4d78c">reentrant</a>.<a class="code" href="structsol__reentrant.html#a3b0f6f7122f0a296a1f8d5628072c6bc">delete_me</a>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abf5df3c3e80848524bcc63193da0469c">read_timeout</a>) {</div>
<div class="line">        <a class="code" href="group__Mainloop.html#gae1f45ba3de62603e90903d1214cf834f">sol_timeout_del</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abf5df3c3e80848524bcc63193da0469c">read_timeout</a>);</div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abf5df3c3e80848524bcc63193da0469c">read_timeout</a> = NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a3c24f022235965c0d0463c6205d5e63e">read_monitor</a>) {</div>
<div class="line">        <a class="code" href="stream__sample_8c.html#aaf09ef4a61479f0f07e2c98f0a44e413">my_stream_device_remove_io_monitor</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a3c24f022235965c0d0463c6205d5e63e">read_monitor</a>);</div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a3c24f022235965c0d0463c6205d5e63e">read_monitor</a> = NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a6730010206b507c04b52945c7a726248">write_monitor</a>) {</div>
<div class="line">        <a class="code" href="stream__sample_8c.html#aaf09ef4a61479f0f07e2c98f0a44e413">my_stream_device_remove_io_monitor</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a6730010206b507c04b52945c7a726248">write_monitor</a>);</div>
<div class="line">        handle-&gt;<a class="code" href="structmy__stream__api__handle.html#a6730010206b507c04b52945c7a726248">write_monitor</a> = NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">//The user is trying to delete the handle from the on_data, do not delete it now.</span></div>
<div class="line">    <a class="code" href="group__Reentrant.html#ga6b0fac049a35897fc6d6551fb72e3eb7">SOL_REENTRANT_FREE</a>(handle-&gt;<a class="code" href="structmy__stream__api__handle.html#abe5c53a9b38f4b6c1d2d6f6105a4d78c">reentrant</a>) {</div>
<div class="line">        <a class="code" href="stream__sample_8c.html#ac0e72426d06273925e202bfef56a127d">api_close</a>(handle);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
</div><!-- fragment --> <h2><a class="anchor" id="usage"></a>
Usage Example</h2>
<p>In the following example, it will be demonstrated how one can correctly use a stream API. The example is consists in an UART producer producing more data than an UART consumer can read. By doing so, it will be demonstrated how flow control can be employed.</p>
<p>First we start configuring the streams and creating the streams. </p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a class="code" href="browse_8c.html#a8f65ca9f5a72be7fe776126fc632f8a9">startup</a>(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structsol__uart__config.html">sol_uart_config</a> producer_config = {</div>
<div class="line">        <a class="code" href="group__Mainloop.html#ga794a88f51470a85bb21279b32cc570ca">SOL_SET_API_VERSION</a>(.<a class="code" href="structsol__uart__config.html#a6bbd1a72654e6f9cb1a794bea57d6621">api_version</a> = <a class="code" href="sol-uart_8h.html#a6970cba74f97b42be0b6a03c18e0ceab">SOL_UART_CONFIG_API_VERSION</a>, )</div>
<div class="line">        .baud_rate = <a class="code" href="group__UART.html#ggaae564795dd91be6d751299c422725de6a5429907f2937cd9331561f0d3ab22da1">SOL_UART_BAUD_RATE_9600</a>,</div>
<div class="line">        .data_bits = <a class="code" href="group__UART.html#gga97c7889a7f0906d9182d214281e862b2ad8e1ddd48f860005df2b2cd58bcd66d1">SOL_UART_DATA_BITS_8</a>,</div>
<div class="line">        .parity = <a class="code" href="group__UART.html#gga147d7dc05fe10ea3a16db08d1f985db0aa81b3ce41af4f785897021db4e2b6544">SOL_UART_PARITY_NONE</a>,</div>
<div class="line">        .stop_bits = <a class="code" href="group__UART.html#ggab3145a8bc5c31c5e6632b8389b86b2edaf77490a7274ba43bb8adf2e0550baee9">SOL_UART_STOP_BITS_ONE</a>,</div>
<div class="line">        .on_feed_done = <a class="code" href="uart_8c.html#a8694ec865bfd7b8d243ca28de0957684">producer_data_written</a>,</div>
<div class="line">        .feed_size = <a class="code" href="uart_8c.html#a56e69a9cc5c3a49f88fd0214f78f54d6">FEED_SIZE</a> <span class="comment">//Note that feed buffer is limited!</span></div>
<div class="line">    };</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structsol__uart__config.html">sol_uart_config</a> consumer_config = {</div>
<div class="line">        <a class="code" href="group__Mainloop.html#ga794a88f51470a85bb21279b32cc570ca">SOL_SET_API_VERSION</a>(.<a class="code" href="structsol__uart__config.html#a6bbd1a72654e6f9cb1a794bea57d6621">api_version</a> = <a class="code" href="sol-uart_8h.html#a6970cba74f97b42be0b6a03c18e0ceab">SOL_UART_CONFIG_API_VERSION</a>, )</div>
<div class="line">        .baud_rate = <a class="code" href="group__UART.html#ggaae564795dd91be6d751299c422725de6a5429907f2937cd9331561f0d3ab22da1">SOL_UART_BAUD_RATE_9600</a>,</div>
<div class="line">        .data_bits = <a class="code" href="group__UART.html#gga97c7889a7f0906d9182d214281e862b2ad8e1ddd48f860005df2b2cd58bcd66d1">SOL_UART_DATA_BITS_8</a>,</div>
<div class="line">        .parity = <a class="code" href="group__UART.html#gga147d7dc05fe10ea3a16db08d1f985db0aa81b3ce41af4f785897021db4e2b6544">SOL_UART_PARITY_NONE</a>,</div>
<div class="line">        .stop_bits = <a class="code" href="group__UART.html#ggab3145a8bc5c31c5e6632b8389b86b2edaf77490a7274ba43bb8adf2e0550baee9">SOL_UART_STOP_BITS_ONE</a>,</div>
<div class="line">        .on_data = <a class="code" href="uart_8c.html#a1c8a75dae299b5c84afe1f2ec1735aea">consumer_read_available</a>,</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">char</span> **argv;</div>
<div class="line">    <span class="keywordtype">int</span> argc;</div>
<div class="line"></div>
<div class="line">    argc = <a class="code" href="group__Mainloop.html#ga12cabf4e32145c725bb37bf94515d397">sol_argc</a>();</div>
<div class="line">    argv = <a class="code" href="group__Mainloop.html#ga924fdfbe38b222739c2bc43a63802fac">sol_argv</a>();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (argc &lt; 3) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Usage: %s &lt;producerUART&gt; &lt;consumerUART&gt;\n&quot;</span>, argv[0]);</div>
<div class="line">        <span class="keywordflow">goto</span> err_exit;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="uart_8c.html#a9a72b10cfa6ae68070956e2f3478dc22">producer</a> = <a class="code" href="group__UART.html#ga9ccf851073317c85e4f72ec197ae2556">sol_uart_open</a>(argv[1], &amp;producer_config);</div>
<div class="line">    <span class="keywordflow">if</span> (!<a class="code" href="uart_8c.html#a9a72b10cfa6ae68070956e2f3478dc22">producer</a>) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not create the producer!\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">goto</span> err_exit;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="uart_8c.html#a69f5aa89cdbb8f95230645b8036d609c">consumer</a> = <a class="code" href="group__UART.html#ga9ccf851073317c85e4f72ec197ae2556">sol_uart_open</a>(argv[2], &amp;consumer_config);</div>
<div class="line">    <span class="keywordflow">if</span> (!<a class="code" href="uart_8c.html#a69f5aa89cdbb8f95230645b8036d609c">consumer</a>) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not create the consumer\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">goto</span> err_exit;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">//This will produce all the data to be sent</span></div>
<div class="line">    <a class="code" href="uart_8c.html#a2fb0f9e777be7400a884f58fb79ae0ab">producer_timeout</a> = <a class="code" href="group__Mainloop.html#ga9d0cd6af9dab4da3002e5cd596ce604f">sol_timeout_add</a>(10, <a class="code" href="uart_8c.html#af9f6c5e151a851d960a38b4d4b1cb432">producer_make_data</a>, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (!<a class="code" href="uart_8c.html#a2fb0f9e777be7400a884f58fb79ae0ab">producer_timeout</a>) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not create the producer timeout!\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">goto</span> err_exit;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">err_exit:</div>
<div class="line">    <a class="code" href="group__Mainloop.html#ga56c31320e4348c91a719039b5a22dd25">sol_quit</a>();</div>
<div class="line">}</div>
</div><!-- fragment --><p> The producer will create its data every 10 ms ticks and try to send it. Since the producer buffer is limited <a class="el" href="group__UART.html#ga6ef429c957d5aacaaa9fdb61ba4e0b7b" title="Perform an UART asynchronous transmission. ">sol_uart_feed()</a> will start to return -ENOSPC, because the sum of all blobs are limited to <code>feed_size</code>.</p>
<p>Below we can see how the data is produced and sent. </p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span></div>
<div class="line"><a class="code" href="uart_8c.html#ac7f3be202700792259fedf833dcf695a">send_blob</a>(<span class="keyword">struct</span> <a class="code" href="structsol__blob.html">sol_blob</a> *blob)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> err;</div>
<div class="line">    <span class="keywordtype">bool</span> r = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Actually write the blob into UART bus</span></div>
<div class="line">    err = <a class="code" href="group__UART.html#ga6ef429c957d5aacaaa9fdb61ba4e0b7b">sol_uart_feed</a>(<a class="code" href="uart_8c.html#a9a72b10cfa6ae68070956e2f3478dc22">producer</a>, blob);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        <span class="comment">//Oh no, there&#39;s no more space left.</span></div>
<div class="line">        <span class="keywordflow">if</span> (err == -ENOSPC) {</div>
<div class="line">            <a class="code" href="uart_8c.html#ac8039a169abc660ac9616fd0df720f68">pending_blob</a> = blob;</div>
<div class="line">            printf(<span class="stringliteral">&quot;No space left in the tx buffer - saving blob for later. Data: %.*s\n&quot;</span>,</div>
<div class="line">                <a class="code" href="group__Str__Slice.html#ga10c9d829c4d0c50467106a14190d7611">SOL_STR_SLICE_PRINT</a>(<a class="code" href="group__Str__Slice.html#gafc4606ede8c6c6bf264e71b08f0338e7">sol_str_slice_from_blob</a>(<a class="code" href="uart_8c.html#ac8039a169abc660ac9616fd0df720f68">pending_blob</a>)));</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Could not not perform an UART write - Reason: %s\n&quot;</span>,</div>
<div class="line">                <a class="code" href="group__Utils.html#gab584188ab3f38605dab8b04aaa85913d">sol_util_strerrora</a>(-r));</div>
<div class="line">            r = <span class="keyword">false</span>;</div>
<div class="line">            <a class="code" href="group__Types.html#gaaf14a0023ae6a06a7e9960e5b622a2ad">sol_blob_unref</a>(blob);</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <a class="code" href="group__Types.html#gaaf14a0023ae6a06a7e9960e5b622a2ad">sol_blob_unref</a>(blob);</div>
<div class="line">        <span class="keywordflow">if</span> (blob == <a class="code" href="uart_8c.html#ac8039a169abc660ac9616fd0df720f68">pending_blob</a>)</div>
<div class="line">            <a class="code" href="uart_8c.html#ac8039a169abc660ac9616fd0df720f68">pending_blob</a> = NULL; <span class="comment">//Flag that data production can start once again!</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> r;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span></div>
<div class="line"><a class="code" href="uart_8c.html#af9f6c5e151a851d960a38b4d4b1cb432">producer_make_data</a>(<span class="keywordtype">void</span> *data)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">void</span> *v;</div>
<div class="line">    <span class="keywordtype">size_t</span> size;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structsol__blob.html">sol_blob</a> *blob;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structsol__buffer.html">sol_buffer</a> buf = <a class="code" href="group__Buffer.html#gaa713288ab086f3fcd98c51870a571a52">SOL_BUFFER_INIT_EMPTY</a>;</div>
<div class="line">    <span class="keyword">static</span> uint16_t packets_created = 0;</div>
<div class="line">    <span class="keywordtype">bool</span> keep_running = <span class="keyword">true</span>;</div>
<div class="line">    <span class="keywordtype">int</span> r;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Stop the production until the pendind blob is sent</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="uart_8c.html#ac8039a169abc660ac9616fd0df720f68">pending_blob</a>) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Waiting for blob data: %.*s to be transferred.\n&quot;</span>,</div>
<div class="line">            <a class="code" href="group__Str__Slice.html#ga10c9d829c4d0c50467106a14190d7611">SOL_STR_SLICE_PRINT</a>(<a class="code" href="group__Str__Slice.html#gafc4606ede8c6c6bf264e71b08f0338e7">sol_str_slice_from_blob</a>(<a class="code" href="uart_8c.html#ac8039a169abc660ac9616fd0df720f68">pending_blob</a>)));</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    packets_created++;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Generate data</span></div>
<div class="line">    <span class="keywordflow">if</span> (packets_created != <a class="code" href="uart_8c.html#ae2bcbf05a79de1a8a42492a8e5169c22">MAX_PACKETS</a>)</div>
<div class="line">        r = <a class="code" href="group__Utils.html#ga24d7f46816d3af0d591209568477d257">sol_util_uuid_gen</a>(<span class="keyword">true</span>, <span class="keyword">true</span>, &amp;buf);</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        r = <a class="code" href="group__Buffer.html#ga48b9fa527ababb11b0bdc5814927b520">sol_buffer_append_slice</a>(&amp;buf, <a class="code" href="group__Str__Slice.html#ga403d23f24219db595e892573d3384c37">sol_str_slice_from_str</a>(<span class="stringliteral">&quot;close&quot;</span>));</div>
<div class="line">        keep_running = <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (r &lt; 0) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not create the UUID - Reason: %s\n&quot;</span>,</div>
<div class="line">            <a class="code" href="group__Utils.html#gab584188ab3f38605dab8b04aaa85913d">sol_util_strerrora</a>(-r));</div>
<div class="line">        <span class="keywordflow">goto</span> err_exit;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    v = <a class="code" href="group__Buffer.html#ga75e2a0d3e0c120fe9315e4cdcf6261ab">sol_buffer_steal</a>(&amp;buf, &amp;size);</div>
<div class="line"></div>
<div class="line">    blob = <a class="code" href="group__Types.html#ga42c9abd2ff9950e7ac828c313fb758c9">sol_blob_new</a>(&amp;<a class="code" href="group__Types.html#gafc93597dbfb82dd2b50ce0261d583895">SOL_BLOB_TYPE_DEFAULT</a>, NULL,</div>
<div class="line">        v, size + 1);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!blob) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not alloc memory for the blob\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">goto</span> err_exit;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Send it</span></div>
<div class="line">    <span class="keywordflow">if</span> (!<a class="code" href="uart_8c.html#ac7f3be202700792259fedf833dcf695a">send_blob</a>(blob))</div>
<div class="line">        <span class="keywordflow">goto</span> err_exit;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!keep_running)</div>
<div class="line">        <span class="keywordflow">goto</span> exit;</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line">err_exit:</div>
<div class="line">    <a class="code" href="group__Mainloop.html#ga56c31320e4348c91a719039b5a22dd25">sol_quit</a>();</div>
<div class="line">exit:</div>
<div class="line">    <a class="code" href="uart_8c.html#a2fb0f9e777be7400a884f58fb79ae0ab">producer_timeout</a> = NULL;</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"></div>
</div><!-- fragment --><p> It's important to note that every time <a class="el" href="group__UART.html#ga6ef429c957d5aacaaa9fdb61ba4e0b7b" title="Perform an UART asynchronous transmission. ">sol_uart_feed()</a> returns <code>-ENOSPC</code> the data production is ceased and the blob that could not be sent is stored at the <code>pending_blob</code> variable.</p>
<p>Every time a blob is completely written, the <code>on_feed_done</code> is called, in this case <code>producer_data_written</code> function. In this function the <code>pending_blob</code> variable is checked to see if it's not <code>NULL</code>. In case it's not NULL, we try to send it.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a class="code" href="uart_8c.html#a8694ec865bfd7b8d243ca28de0957684">producer_data_written</a>(<span class="keywordtype">void</span> *data, <span class="keyword">struct</span> <a class="code" href="group__UART.html#ga810a1c2f354acba92a33ee97806ad3d1">sol_uart</a> *uart, <span class="keyword">struct</span> <a class="code" href="structsol__blob.html">sol_blob</a> *blob, <span class="keywordtype">int</span> status)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structsol__str__slice.html">sol_str_slice</a> slice;</div>
<div class="line"></div>
<div class="line">    slice = <a class="code" href="group__Str__Slice.html#gafc4606ede8c6c6bf264e71b08f0338e7">sol_str_slice_from_blob</a>(blob);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (status &lt; 0) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not write the UUID %.*s - Reason: %s\n&quot;</span>, <a class="code" href="group__Str__Slice.html#ga10c9d829c4d0c50467106a14190d7611">SOL_STR_SLICE_PRINT</a>(slice),</div>
<div class="line">            <a class="code" href="group__Utils.html#gab584188ab3f38605dab8b04aaa85913d">sol_util_strerrora</a>(-status));</div>
<div class="line">        <a class="code" href="group__Mainloop.html#ga56c31320e4348c91a719039b5a22dd25">sol_quit</a>();</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Producer: UUID %.*s written\n&quot;</span>, <a class="code" href="group__Str__Slice.html#ga10c9d829c4d0c50467106a14190d7611">SOL_STR_SLICE_PRINT</a>(slice));</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="uart_8c.html#ac8039a169abc660ac9616fd0df720f68">pending_blob</a>) { <span class="comment">//If we have a pending blob now it&#39;s the time to try to send it!</span></div>
<div class="line">            <span class="keywordflow">if</span> (!<a class="code" href="uart_8c.html#ac7f3be202700792259fedf833dcf695a">send_blob</a>(<a class="code" href="uart_8c.html#ac8039a169abc660ac9616fd0df720f68">pending_blob</a>)) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;Could not send the pending blob!\n&quot;</span>);</div>
<div class="line">                <a class="code" href="group__Mainloop.html#ga56c31320e4348c91a719039b5a22dd25">sol_quit</a>();</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p> By stopping the data production when <a class="el" href="group__UART.html#ga6ef429c957d5aacaaa9fdb61ba4e0b7b" title="Perform an UART asynchronous transmission. ">sol_uart_feed()</a> returns <code>-ENOSPC</code> we control the data input flow. After <a class="el" href="group__UART.html#ga6ef429c957d5aacaaa9fdb61ba4e0b7b" title="Perform an UART asynchronous transmission. ">sol_uart_feed()</a> starts to accept blobs, the data production can start once again.</p>
<p>Now it's time to take a look at our consumer. It's a very naive consumer, it will just print the data to <code>stdout</code> every time the nul byte is found. In addiction it will close the UART input if it receives the "close" string. Note that is completely safe to close the UART from the <code>on_data</code> (the same applies to <code>on_feed_done!</code>)</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> ssize_t</div>
<div class="line"><a class="code" href="uart_8c.html#a1c8a75dae299b5c84afe1f2ec1735aea">consumer_read_available</a>(<span class="keywordtype">void</span> *data, <span class="keyword">struct</span> <a class="code" href="group__UART.html#ga810a1c2f354acba92a33ee97806ad3d1">sol_uart</a> *uart, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structsol__buffer.html">sol_buffer</a> *buf)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structsol__str__slice.html">sol_str_slice</a> slice = <a class="code" href="group__Buffer.html#ga8514e78d12dbe8c959af39de05f7c547">sol_buffer_get_slice</a>(buf);</div>
<div class="line">    <span class="keywordtype">char</span> *sep;</div>
<div class="line"></div>
<div class="line">    sep = memchr(slice.<a class="code" href="structsol__str__slice.html#a38ae63b741a375104ae7cc3a5da911a4">data</a>, <span class="charliteral">&#39;\0&#39;</span>, slice.<a class="code" href="structsol__str__slice.html#a9b9f38d8d946af896daf76fab04473b7">len</a>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!sep)</div>
<div class="line">        <span class="keywordflow">return</span> 0; <span class="comment">//Bytes will not be removed fom the rx buffer</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">//Close the UART!</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group__Str__Slice.html#ga0f4d08b88b025e80b53b5a29f6874438">sol_str_slice_str_contains</a>(slice, <span class="stringliteral">&quot;close&quot;</span>)) {</div>
<div class="line">        <a class="code" href="group__UART.html#gae577df6de9ef3e7e055dc1a532365c21">sol_uart_close</a>(uart); <span class="comment">//This is completely safe</span></div>
<div class="line">        <a class="code" href="uart_8c.html#a69f5aa89cdbb8f95230645b8036d609c">consumer</a> = NULL;</div>
<div class="line">        printf(<span class="stringliteral">&quot;\n\n** Consumer **: Received the close command\n\n&quot;</span>);</div>
<div class="line">        <a class="code" href="group__Mainloop.html#ga56c31320e4348c91a719039b5a22dd25">sol_quit</a>();</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        printf(<span class="stringliteral">&quot;\n\n** Consumer ** : Received UUID %.*s\n\n&quot;</span>,</div>
<div class="line">            <a class="code" href="group__Str__Slice.html#ga10c9d829c4d0c50467106a14190d7611">SOL_STR_SLICE_PRINT</a>(slice));</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> slice.<a class="code" href="structsol__str__slice.html#a9b9f38d8d946af896daf76fab04473b7">len</a>; <span class="comment">//slice.len bytes will be removed from the rx buffer</span></div>
<div class="line">}</div>
</div><!-- fragment --><p> Now that you have the stream usage basics, you can start coding your apps!</p>
<h2><a class="anchor" id="implementations"></a>
Implementations</h2>
<p>Soletta currently implements streams for the following modules: </p>
<ul>
<li>
<a class="el" href="group__UART.html">UART</a> <ul>
<li>
<a class="el" href="group__UART.html#ga6ef429c957d5aacaaa9fdb61ba4e0b7b" title="Perform an UART asynchronous transmission. ">sol_uart_feed()</a> </li>
<li>
struct <a class="el" href="structsol__uart__config.html" title="A configuration struct used to set the UART paramenters. ">sol_uart_config</a> </li>
</ul>
</li>
<li>
<a class="el" href="group__Crypto.html">Cryptography And Signatures</a> <ul>
<li>
<a class="el" href="group__Message__Digest.html#ga6bd8e2b7f7f3994c7c105b77675e4d89" title="Feed message (data) to be digested (hashed). ">sol_message_digest_feed()</a> </li>
<li>
struct <a class="el" href="structsol__message__digest__config.html" title="The message digest configuration to use when creating a new handle. ">sol_message_digest_config</a> </li>
</ul>
</li>
<li>
<a class="el" href="group__HTTP.html">HTTP</a> <ul>
<li>
<a class="el" href="group__HTTP__SERVER.html#gaa68635a1da8efbbb19db552230950542" title="Send data for the progressive response. ">sol_http_progressive_response_feed()</a> </li>
<li>
<a class="el" href="group__HTTP__SERVER.html#ga412c7f2d67e2c7f41d2504b0c550a312" title="Send sse data for the progressive response. ">sol_http_progressive_response_sse_feed()</a> </li>
<li>
struct <a class="el" href="structsol__http__server__progressive__config.html" title="Progressive server response configuration. ">sol_http_server_progressive_config</a> </li>
<li>
struct <a class="el" href="structsol__http__request__interface.html" title="The HTTP request interface to use when creating a new request. ">sol_http_request_interface</a> </li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.9.1-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
<a href="http://solettaproject.github.io/docs/">Full online documentation</a> | 
<a href="index.html">C API Index</a>
</small></address>
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
